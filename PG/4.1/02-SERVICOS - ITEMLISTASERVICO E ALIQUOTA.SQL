SELECT
    CASE 
        WHEN CADPRODUTO.LST ~ '[0-9]{6}' 
        THEN (REGEXP_MATCH(CADPRODUTO.LST,'[0-9]{6}'))[1]
        WHEN CADPRODUTO.LST ~ '[0-9]{4}' 
        THEN CADPRODUTO.LST|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]{2}\.[0-9]{2}' 
        THEN REPLACE(CADPRODUTO.LST,'.','')|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]\.[0-9]{2}' 
        THEN '0'||REPLACE(CADPRODUTO.LST,'.','')|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]{4}' 
        THEN COALESCE(CADPRODUTO.NCM) || '01'
        ELSE '090101'
    END AS IDLISTASERVICO, --== CTRIBMUN
    CADNBS.IDNBS, 
    '' AS IDREFERENCIA,
--    (REGEXP_MATCH(CADPRODUTO.LST,'[0-9]{6}\.([0-9]{1,3})'))[1] AS CODIGOTRIBUTACAOMUNICIPIO,
    (REGEXP_MATCH(CADIMPOSTO.OBSIMPOSTO,'[0-9]{6}\.([0-9]{1,3})'))[1] AS CODIGOTRIBUTACAOMUNICIPIO,
    CADPRODUTO.CFPSDENTROMUNIC AS IDCFPS,
    NOTASFISCAIS.ALIQISS,
    NOTASFISCAIS.VALISS AS VLISS,
    /*Reforma Tribut√°ria*/
    COALESCE(MAX(fiscalitemimposto.idcst),'000001') AS IDCLASSIFICACAOTRIBUTARIA,
    '030101' AS Codigo_Indicador_Operacao --no estabelecimento fornecedor
--    '000001' AS IDCLASSIFICACAOTRIBUTARIA
  FROM NOTASFISCAIS
  JOIN DETNOTAFISCAL ON DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL
    LEFT JOIN CADPRODUTO ON CADPRODUTO.CODPRODUTO=
          COALESCE(NULLIF( DETNOTAFISCAL.CODPRODAGRUPADOR,0),
          COALESCE(NULLIF( DETNOTAFISCAL.CODPRODUTO,0),
          COALESCE(NULLIF( DETNOTAFISCAL.CODPRODCADASTRO ,0)
          )))
          AND CADPRODUTO.CODHOTEL=DETNOTAFISCAL.CODHOTEL
    LEFT JOIN CADIMPOSTO ON CADIMPOSTO.CODIMPOSTO = COALESCE(DETNOTAFISCAL.CODIMPOSTO,CADPRODUTO.CODIMPOSTO)
          AND CADIMPOSTO.CODHOTEL = DETNOTAFISCAL.CODHOTEL
    LEFT JOIN CADNBS ON CADNBS.CODNBS = CADPRODUTO.CODNBS AND CADNBS.CODHOTEL = CADPRODUTO.CODHOTEL 
    ---
    LEFT JOIN FISCALITEMIMPOSTO ON FISCALITEMIMPOSTO.CDORIGEMDOCITEM = DETNOTAFISCAL.DETCODNOTA AND FISCALITEMIMPOSTO.CODHOTEL = DETNOTAFISCAL.CODHOTEL AND FISCALITEMIMPOSTO.FLIMPOSTOABRANGENCIA = 0
    ---
  WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
  AND NOTASFISCAIS.CODNOTA = :CDNOTA
GROUP BY DETNOTAFISCAL.CODPRODUTO,
  DETNOTAFISCAL.ALIQUOTA,
  NOTASFISCAIS.ALIQISS,
  DETNOTAFISCAL.DESCRICAO,
  CADPRODUTO.LST,
  CADPRODUTO.NCM,
  CADNBS.IDNBS, 
  --DETNOTAFISCAL.IDNBS,
  DETNOTAFISCAL.IDCEST,
  CADPRODUTO.CFPSDENTROMUNIC,
  DETNOTAFISCAL.TIPOIMPOSTO,
  CADIMPOSTO.OBSIMPOSTO
ORDER BY DETNOTAFISCAL.TIPOIMPOSTO='S' AND MAX(DETNOTAFISCAL.CODPRODUTO) IS NULL AND MAX(DETNOTAFISCAL.UNIDADE) IS NULL AND MAX(DETNOTAFISCAL.VALUNIT) IS NULL
,SUM(DETNOTAFISCAL.VALTOTAL) DESC
LIMIT 1