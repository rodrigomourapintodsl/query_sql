SELECT
    CASE 
        WHEN CADPRODUTO.LST ~ '[0-9]{6}' 
        THEN (regexp_match(CADPRODUTO.LST,'[0-9]{6}'))[1]
        WHEN CADPRODUTO.LST ~ '[0-9]{4}' 
        THEN CADPRODUTO.LST|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]{2}\.[0-9]{2}' 
        THEN REPLACE(CADPRODUTO.LST,'.','')|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]\.[0-9]{2}' 
        THEN '0'||REPLACE(CADPRODUTO.LST,'.','')|| '01'
        WHEN CADPRODUTO.LST ~ '[0-9]{4}' 
        THEN COALESCE(CADPRODUTO.ncm) || '01'
        ELSE '090101'
    END AS IDLISTASERVICO, --== cTribMun
    cadnbs.idnbs, 
    '' AS idreferencia,
--    (regexp_match(CADPRODUTO.LST,'[0-9]{6}\.([0-9]{1,3})'))[1] AS CodigoTributacaoMunicipio,
    (regexp_match(cadimposto.obsimposto,'[0-9]{6}\.([0-9]{1,3})'))[1] AS CodigoTributacaoMunicipio,
    CADPRODUTO.cfpsdentromunic AS idcfps,
    DETNOTAFISCAL.CSTPIS AS CSTPIS,
    NOTASFISCAIS.aliqiss,
--    COALESCE(MAX(DOCFISCALITEMIVADUAL.IDCLASSIFICACAOTRIBUTARIA),'100001') AS IDCLASSIFICACAOTRIBUTARIA
    '100001' AS IDCLASSIFICACAOTRIBUTARIA
  FROM NOTASFISCAIS
  JOIN DETNOTAFISCAL ON DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL
    LEFT JOIN CADPRODUTO ON CADPRODUTO.CODPRODUTO=
          COALESCE(NULLIF( DETNOTAFISCAL.CODPRODUTO,0),
          COALESCE(NULLIF( DETNOTAFISCAL.codprodcadastro ,0),
          COALESCE(NULLIF( DETNOTAFISCAL.codprodagrupador,0)
          )))
          AND CADPRODUTO.CODHOTEL=DETNOTAFISCAL.CODHOTEL
    LEFT JOIN cadimposto ON cadimposto.codimposto = COALESCE(DETNOTAFISCAL.codimposto,CADPRODUTO.codimposto)
          AND cadimposto.CODHOTEL = DETNOTAFISCAL.CODHOTEL
    LEFT JOIN cadnbs ON cadnbs.codnbs = CADPRODUTO.codnbs AND cadnbs.CODHOTEL = CADPRODUTO.CODHOTEL 
-- LEFT JOIN DOCFISCALITEMIVADUAL 
-- ON DOCFISCALITEMIVADUAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
-- LEFT JOIN DOCFISCALITEMIMPOSTO IBSMUNICIPAL 
-- ON IBSMUNICIPAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
-- AND IBSMUNICIPAL.CDTIPOIMPOSTODET = 9 
  WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
  AND NOTASFISCAIS.CODNOTA = :CDNOTA
GROUP BY DETNOTAFISCAL.codproduto,
  DETNOTAFISCAL.aliquota,
  NOTASFISCAIS.aliqiss,
  DETNOTAFISCAL.descricao,
  CADPRODUTO.LST,
  CADPRODUTO.ncm,
  cadnbs.idnbs, 
  --DETNOTAFISCAL.idnbs,
  DETNOTAFISCAL.idcest,
  CADPRODUTO.cfpsdentromunic,
  DETNOTAFISCAL.TIPOIMPOSTO,cadimposto.obsimposto
ORDER BY DETNOTAFISCAL.TIPOIMPOSTO='S' AND max(DETNOTAFISCAL.CODPRODUTO) IS NULL AND max(DETNOTAFISCAL.UNIDADE) IS NULL AND MAX(DETNOTAFISCAL.VALUNIT) IS NULL
,SUM(DETNOTAFISCAL.valtotal) DESC
LIMIT 1