SELECT
    CASE
        COALESCE(ADIANTAMENTO.TIPOPGTO, PDVAPGTORAZAO.TIPOPGTO, PGTORAZAO.TIPOPGTO, RAZOES.TIPOPGTO)
        WHEN 1 THEN 'Dinheiro'
        WHEN 2 THEN 'Cheque'
        WHEN 3 THEN 'Cartão'
        WHEN 4 THEN CASE 
                        WHEN CADEMPRESA.NOMEEMPRESA IN ('PIX') THEN CADEMPRESA.NOMEEMPRESA
            WHEN CADEMPRESA.NOMEEMPRESA LIKE 'PIX %' THEN 'PIX'
            WHEN (
                ' ' || UPPER(CADEMPRESA.NOMEEMPRESA)|| ' '
            ) LIKE '% PIX %' THEN 'PIX'
            WHEN CADEMPRESA.tipocartao = 1 THEN 'Crédito:' || CADEMPRESA.NOMEEMPRESA
            ELSE 'Débito:' || CADEMPRESA.NOMEEMPRESA
        END
        WHEN 5 THEN 'À Prazo'
        WHEN 6 THEN 'Cortesia'
        WHEN 7 THEN 'Permuta'
        WHEN 8 THEN 'OM2'
        WHEN 10 THEN 'Adiantamento' || COALESCE((SELECT ' Reserva:' || MAX(reserva.NRORESERVA) FROM detestat JOIN ESTATISTICA ON detestat.ACESSO = ESTATISTICA.ACESSO JOIN RESERVA ON RESERVA.CODRESERVA = ESTATISTICA.NRORESERVA WHERE detestat.ACESSODET = RAZOES.ACESSO ), '')
        WHEN 13 THEN 'Transferência Bancaria'
        WHEN 17 THEN 'Pix'
        WHEN 45 THEN 'PIS Retiro'
        WHEN 46 THEN 'IR Retiro'
        WHEN 47 THEN 'Cofins Retiro'
        WHEN 48 THEN 'CRLL Retiro'
        WHEN 95 THEN 'Cancelada'
        ELSE CASE
            WHEN RAZOES.SITUACAO = 'C' THEN 'Cancelado'
        END
    END
AS XPAG,
/*Modalidade de pagamento*/
-- 0. Não se aplica
-- 1. Débito
-- 2. Crédito
-- 3. Dinheiro
-- 4. Eletrônico
-- 5. Pagamento posterior
CASE COALESCE(ADIANTAMENTO.TIPOPGTO, PDVAPGTORAZAO.TIPOPGTO, PGTORAZAO.TIPOPGTO, RAZOES.TIPOPGTO)
    WHEN 1 THEN 3
    WHEN 2 THEN 2
    WHEN 3 THEN 4
    WHEN 4 THEN CASE  
                WHEN CADEMPRESA.NOMEEMPRESA IN ('PIX') THEN 4
                WHEN CADEMPRESA.NOMEEMPRESA LIKE 'PIX %' THEN 4
                WHEN (' '|| CADEMPRESA.NOMEEMPRESA||' ') ILIKE '% PIX %' THEN 4
                WHEN CADEMPRESA.tipocartao = 1 THEN 2 ELSE 1 END
    WHEN 5 THEN 5
    -- WHEN 6 THEN 0
    -- WHEN 7 THEN 0
    WHEN 8 THEN 5
    WHEN 10 THEN 5
    WHEN 13 THEN 4
    WHEN 17 THEN 4
    -- WHEN 45 THEN 0
    -- WHEN 46 THEN 0
    -- WHEN 47 THEN 0
    -- WHEN 48 THEN 0
    -- WHEN 95 THEN 0
END AS modPagamento,
    2 AS MDPRESTACAO_COMEXT,
    0 AS VINCPREST_COMEXT,
    '790' AS TPMOEDA_COMEXT, --moeda ISO 4217 --https://www.bcb.gov.br/estabilidadefinanceira/todasmoedas
    NOTASFISCAIS.TOTALNOTA AS VSERVMOEDA
FROM NOTASFISCAIS
LEFT JOIN PGTORAZAO 
    ON  NOTASFISCAIS.CODRAZAO = PGTORAZAO.CODRAZAO
    AND NOT NOTASFISCAIS.ORIGEM IN (5)
    AND NOTASFISCAIS.CODHOTEL = PGTORAZAO.CODHOTEL
LEFT JOIN PDVAPGTORAZAO 
    ON  NOTASFISCAIS.CODRAZAO = PDVAPGTORAZAO.CODRAZAO
    AND NOTASFISCAIS.ORIGEM IN (5)
    AND NOTASFISCAIS.CODHOTEL = PDVAPGTORAZAO.CODHOTEL
LEFT JOIN RAZOES 
    ON  NOTASFISCAIS.CODRAZAO = RAZOES.CODRAZAO
    AND NOT NOTASFISCAIS.ORIGEM IN (5)
    AND NOTASFISCAIS.CODHOTEL = RAZOES.CODHOTEL
LEFT JOIN PDVARAZAO 
    ON  NOTASFISCAIS.CODRAZAO = PDVARAZAO.CODRAZAO
    AND NOTASFISCAIS.ORIGEM IN (5)
    AND NOTASFISCAIS.CODHOTEL = PDVARAZAO.CODHOTEL
LEFT JOIN ADIANTAMENTO 
    ON  ADIANTAMENTO.CODRAZAO = NOTASFISCAIS.CODRAZAO
    AND PGTORAZAO.TIPOPGTO = 10
    AND RAZOES.TIPOPGTO = 11
    AND ADIANTAMENTO.TIPOADIANT NOT IN ('C')
    AND TIPOADIANT = 'L'
    AND ADIANTAMENTO.CODHOTEL = NOTASFISCAIS.CODHOTEL
LEFT JOIN CADEMPRESA 
    ON  CADEMPRESA.TIPOEMP = 'C'
    AND CADEMPRESA.CODEMPRESA = COALESCE (
        ADIANTAMENTO.CODCARTAO,
        PDVAPGTORAZAO.CODCARTAO,
        RAZOES.CODCARTAO
    )
    AND CADEMPRESA.CODHOTEL = NOTASFISCAIS.CODHOTEL
WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
    AND NOTASFISCAIS.CODNOTA = :CDNOTA
ORDER BY NOTASFISCAIS.CODNOTA DESC,
    ADIANTAMENTO.CHAVE,
    PDVARAZAO.CODRAZAO,
    PDVAPGTORAZAO.CDCHAVEPGTO,
    RAZOES.CODRAZAO