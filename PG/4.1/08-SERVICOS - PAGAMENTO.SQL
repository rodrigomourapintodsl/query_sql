SELECT CASE COALESCE(ADIANTAMENTO.TIPOPGTO,PDVAPGTORAZAO.TIPOPGTO,PGTORAZAO.TIPOPGTO,RAZOES.TIPOPGTO)
                        WHEN  1 THEN 'Dinheiro'
                        WHEN  2 THEN 'Cheque'
                        WHEN  3 THEN 'Cartão'
                        WHEN  4 THEN CASE 
                        WHEN CADEMPRESA.NOMEEMPRESA IN ('PIX') THEN CADEMPRESA.NOMEEMPRESA
                        WHEN CADEMPRESA.NOMEEMPRESA  LIKE 'PIX %' THEN 'PIX'
                        WHEN (' '||UPPER(CADEMPRESA.NOMEEMPRESA)||' ')  LIKE '% PIX %' THEN 'PIX'
                                when CADEMPRESA.tipocartao = 1 then 'Crédito:'||CADEMPRESA.NOMEEMPRESA
                                else 'Débito:'||CADEMPRESA.NOMEEMPRESA END
                        WHEN  5 THEN 'À Prazo' 
                        WHEN  6 THEN 'Cortesia'
                        WHEN  7 THEN 'Permuta'
                        WHEN  8 THEN 'OM2'
                        WHEN 10 THEN 'Adiantamento'||COALESCE((SELECT ' Reserva:'||MAX(reserva.NRORESERVA) FROM detestat JOIN ESTATISTICA ON detestat.ACESSO = ESTATISTICA.ACESSO JOIN RESERVA ON RESERVA.CODRESERVA = ESTATISTICA.NRORESERVA  WHERE detestat.ACESSODET = RAZOES.ACESSO ),'')
                        WHEN 13 THEN 'Transferência Bancaria'
                        WHEN 17 THEN 'Pix'
                        WHEN 45 THEN 'PIS Retiro'
                        WHEN 46 THEN 'IR Retiro'
                        WHEN 47 THEN 'Cofins Retiro'
                        WHEN 48 THEN 'CRLL Retiro'
                        WHEN 95 THEN 'Cancelada'
                        ELSE CASE WHEN RAZOES.SITUACAO = 'C' THEN 'Cancelado' END
    END
AS XPAG,
2 AS mdPrestacao_comExt,
0 AS vincPrest_comExt,
'790' AS tpMoeda_comExt, --moeda ISO 4217 --https://www.bcb.gov.br/estabilidadefinanceira/todasmoedas
NOTASFISCAIS.TOTALNOTA AS vServMoeda
    FROM NOTASFISCAIS
    LEFT JOIN PGTORAZAO ON NOTASFISCAIS.CODRAZAO = PGTORAZAO.CODRAZAO AND NOT NOTASFISCAIS.ORIGEM IN ( 5 )
       AND NOTASFISCAIS.CODHOTEL = PGTORAZAO.CODHOTEL
    LEFT JOIN PDVAPGTORAZAO ON NOTASFISCAIS.CODRAZAO = PDVAPGTORAZAO.CODRAZAO AND NOTASFISCAIS.ORIGEM IN ( 5 ) 
       AND NOTASFISCAIS.CODHOTEL = PDVAPGTORAZAO.CODHOTEL 
    LEFT JOIN RAZOES ON NOTASFISCAIS.CODRAZAO = RAZOES.CODRAZAO  AND NOT NOTASFISCAIS.ORIGEM IN ( 5 )
       AND NOTASFISCAIS.CODHOTEL = RAZOES.CODHOTEL 
    LEFT JOIN PDVARAZAO ON NOTASFISCAIS.CODRAZAO = PDVARAZAO.CODRAZAO AND NOTASFISCAIS.ORIGEM IN ( 5 ) 
       AND NOTASFISCAIS.CODHOTEL = PDVARAZAO.CODHOTEL 
    LEFT JOIN ADIANTAMENTO ON ADIANTAMENTO.CODRAZAO = NOTASFISCAIS.CODRAZAO AND PGTORAZAO.TIPOPGTO = 10 AND RAZOES.TIPOPGTO = 11 AND ADIANTAMENTO.tipoadiant not in ('C') and tipoadiant = 'L'
       AND ADIANTAMENTO.CODHOTEL = NOTASFISCAIS.CODHOTEL
    LEFT JOIN CADEMPRESA ON CADEMPRESA.tipoemp = 'C' AND CADEMPRESA.CODEMPRESA  = COALESCE (ADIANTAMENTO.CODCARTAO,PDVAPGTORAZAO.CODCARTAO,RAZOES.CODCARTAO) and CADEMPRESA.codhotel = NOTASFISCAIS.CODHOTEL
    WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
       AND NOTASFISCAIS.CODNOTA = :CDNOTA
   order by NOTASFISCAIS.CODNOTA desc,adiantamento.chave,PDVARAZAO.CODRAZAO,PDVAPGTORAZAO.CDCHAVEPGTO,RAZOES.CODRAZAO
