SELECT 
    CASE WHEN UPPER(NOTASFISCAIS.NOME) NOT IN ('HOSPEDE','PASSANTE','CONSUMIDOR','ACOMPANHANTE','ACOMPANHANTE1','ACOMPANHANTE2','ACOMPANHANTE3','ACOMPANHANTE4','ACOMPANHANTE5','ACOMPANHANTE6')
    THEN CAST( NOTASFISCAIS.nome AS VARCHAR(150)) 
    END AS nome, 
    CASE WHEN  TIPO.TIPOPESSOA > 'E' THEN --Brasil
    regexp_replace(NOTASFISCAIS.CGCCPF , '[^0-9]', '', 'g')
    END AS CGCCPF,
    TIPO.TIPOPESSOA,
    regexp_replace(NOTASFISCAIS.inscmunicipal , '[^0-9]', '', 'g') AS INSCMUNIC,
    CASE WHEN  TIPO.TIPOPESSOA = 'E' AND COALESCE(NULLIF(RIGHT(CAST(NOTASFISCAIS.codpais AS VARCHAR(5)),4),''),'1058') <> '1058'
        THEN CAST(NOTASFISCAIS.CGCCPF AS VARCHAR(40))
    END AS Nif,
    '' AS CAEPF, --Pessoas Físicas
    CASE WHEN COALESCE(NULLIF(RIGHT(CAST(NOTASFISCAIS.codpais AS VARCHAR(5)),4),''),'1058') = '1058'
        THEN 2
        WHEN TIPO.TIPOPESSOA = 'E' 
        THEN 0 ----0-NaoInformado,1-Dispensado,2-NaoExigencia
    END AS cNaoNIF, 
    CASE WHEN LENGTH(NOTASFISCAIS.ENDERECO) > 3 THEN CAST(NOTASFISCAIS.ENDERECO AS VARCHAR(255)) END AS endereco,
    CASE WHEN LENGTH(NOTASFISCAIS.ENDERECO) > 3 THEN COALESCE(NULLIF(NULLIF(regexp_replace( NOTASFISCAIS.nroendereco , '[^0-9]', '', 'g'),''),'0'),'S/N') END AS nroendereco,
    CASE WHEN LENGTH(NOTASFISCAIS.ENDERECO) > 3 THEN NOTASFISCAIS.complemento END AS complemento,
    CASE WHEN LENGTH(NOTASFISCAIS.ENDERECO) > 3 THEN COALESCE(NULLIF(NOTASFISCAIS.bairro,''),'CENTRO') END AS bairro,
    CASE WHEN LENGTH(NOTASFISCAIS.ENDERECO) > 3 THEN NOTASFISCAIS.CodMunicipio END AS CodMunicipio,
    CASE 
        WHEN TIPO.TIPOPESSOA IN ('F','J')
        THEN NOTASFISCAIS.estado
        ELSE 'EX'
    END AS UF,
   CASE WHEN  TIPO.TIPOPESSOA IN ('F','J') AND LENGTH(NOTASFISCAIS.ENDERECO) > 3
    THEN CAST(regexp_replace(NOTASFISCAIS.cep, '[^0-9]', '', 'g') AS VARCHAR(8))
    WHEN COALESCE(REPLACE(NOTASFISCAIS.cep,LEFT(NOTASFISCAIS.cep,1),''),'') = '' 
    THEN '99999999'
    ELSE NOTASFISCAIS.cep
    END AS cep,
        COALESCE(NULLIF(NOTASFISCAIS.cidade,''),NOTASFISCAIS.pais) AS xMunicipio,
    COALESCE(NULLIF(RIGHT(CAST(NOTASFISCAIS.codpais AS VARCHAR(5)),4),''),'1058') AS CodPais,
    '' AS PontoReferencia
FROM NOTASFISCAIS
 JOIN CONFIGURA ON CONFIGURA.CODHOTEL = NOTASFISCAIS.CODHOTEL
  JOIN NFERETORNO ON NOTASFISCAIS.CODNOTA = NFERETORNO.CDNOTA AND NOTASFISCAIS.CODHOTEL = NFERETORNO.CDEMPRESA
 CROSS JOIN LATERAL ( SELECT
 CASE 
        CASE      WHEN CONFIGURA.CGC = NOTASFISCAIS.CGCCPF 
                    THEN 'P'
                  WHEN UPPER(NOTASFISCAIS.NOME) IN ('HOSPEDE','PASSANTE','CONSUMIDOR','ACOMPANHANTE','ACOMPANHANTE1','ACOMPANHANTE2','ACOMPANHANTE3','ACOMPANHANTE4','ACOMPANHANTE5','ACOMPANHANTE6')
                    AND NOTASFISCAIS.PAIS IN ('BRASIL','BRAZIL') AND TRIM(NOTASFISCAIS.CODPAIS) IN ('01058','1058')
                    THEN 'FC' --CONSUMIDOR
                  WHEN  NOTASFISCAIS.PAIS IN ('BRASIL','BRAZIL') AND TRIM(NOTASFISCAIS.CODPAIS) IN ('01058','1058') AND CHAR_LENGTH(NOTASFISCAIS.CGCCPF)=14 AND NOTASFISCAIS.CGCCPF SIMILAR TO '[0-9]{3}\.[0-9]{3}\.[0-9]{3}[^0-9A-Za-z][0-9Xx]{2}'
                    AND NOTASFISCAIS.CGCCPF NOT IN ('000.000.000-00','111.111.111-11','222.222.222-22','333.333.333-33','444.444.444-44','555.555.555-55','666.666.666-66','777.777.777-77','888.888.888-88','999.999.999-99')
                    THEN 'F' --PESSOA FISICA IDENTIFICADA
                  WHEN  NOTASFISCAIS.PAIS IN ('BRASIL','BRAZIL') AND TRIM(NOTASFISCAIS.CODPAIS) IN ('01058','1058') AND CHAR_LENGTH(NOTASFISCAIS.CGCCPF)=18 AND NOTASFISCAIS.CGCCPF SIMILAR TO '[0-9]{2}\.[0-9]{3}\.[0-9]{3}\/[0-9]{4}[^0-9A-Za-z][0-9]{2}'
                    AND NOTASFISCAIS.CGCCPF NOT IN ('00.000.000/0000-00','11.111.111/1111-11','22.222.222/2222-22','33.333.333/3333-33','44.444.444/4444-44','55.555.555/5555-55','66.666.666/6666-66','77.777.777/7777-77','88.888.888/8888-88','99.999.999/9999-99')
                    THEN 'J' --PESSOA JURIDICA
                  WHEN NOTASFISCAIS.PAIS IN ('BRASIL','BRAZIL') AND TRIM(NOTASFISCAIS.CODPAIS) IN ('01058','1058')
                    THEN 'FC' --CONSUMIDOR
                  WHEN NOTASFISCAIS.CODPAIS NOT IN ('01058','1058') AND NOTASFISCAIS.CGCCPF = '' OR NOTASFISCAIS.CGCCPF IS NULL
                    THEN 'E' --EXTRANGEIRO NÃO IDENTIFICADO
                    ELSE 'E' --EXTRANGEIRO
               END
        WHEN 'F'  THEN 'F' --CPF de Pessoa Fisica
        WHEN 'J'  THEN 'J' --CNPJ de Empresa Juridica
        WHEN 'FC' THEN 'C' --Consumidor não identificado
        WHEN 'E'  THEN 'E' --Extrangeiro
        WHEN 'EN' THEN 'E' --Extrangeiro com CPF
        WHEN 'EB' THEN 'C' --Extrangeiro Residente no Brasil comum no RJ
        WHEN 'P'  THEN 'A' --Emissão para o proprio CNPJ
        ELSE 'C' -- Outros
    END AS TIPOPESSOA
) AS TIPO
  WHERE NFERETORNO.CDNOTA = :CDNOTA
  AND NFERETORNO.CDEMPRESA = :CDEMPRESA
  AND NFERETORNO.fltiponota = 1 