SELECT 
    NOTASFISCAIS.CODNOTA AS nDFSe,
    CASE
        WHEN CONFIGURA3.CODIBGEHOTEL IN ('3530607')
        THEN 'SilTecnologia_v1.00'
    END AS verAplic,
    'NFS' 
    ||(SELECT ID FROM (SELECT ''
    || TRIM(TO_CHAR(CAST( CONFIGURA3.CODIBGEHOTEL AS INTEGER),'0000000')) --IBGE
    || '1' -- 1==Ambiente Produção
    || '2' -- 2==CNPJ_EMITENTE
    || REGEXP_REPLACE(CONFIGURA.CGC,'[^0-9]','','g')
    || TRIM(TO_CHAR(NOTASFISCAIS.NRONOTA,'0000000000000'))
    || TRIM(TO_CHAR(NOTASFISCAIS.DATAHORASAIDA,'YYDD'))
    || TRIM(TO_CHAR(NOTASFISCAIS.CODNOTA,'000000000'))
    || CAST(  (SELECT mod(11-MOD(SUM(NFSE_MULT),11),10) AS NFSE_digito FROM (
        SELECT CAST(NFSE as INT) * lINHA as NFSE_MULT FROM (
            select ((ROW_NUMBER() OVER()-1) %8)+2 AS lINHA,NFSE FROM regexp_split_to_table(replace((left(
                '3530607110005555555555500019031281012511055999528'
            ,-1)),'-',''), '[&&]*') AS NFSE
        ) as NFSE_DESC
    ) as A) AS CHAR(1)) ---NFSE_digito_esperado -- Calculo DV
    AS ID ) AS NFS
    )
    AS ID_NFS,
    'DPS' 
    || TRIM(TO_CHAR(CAST( CONFIGURA3.CODIBGEHOTEL AS INTEGER),'0000000')) --IBGE
    || '2' -- 2==CNPJ_EMITENTE
    || REGEXP_REPLACE(CONFIGURA.CGC,'[^0-9]','','g')
    || TRIM(TO_CHAR(CAST( COALESCE(NULLIF(NULLIF(CAST(regexp_replace(NOTASFISCAIS.SERIE, '[^0-9]', '', 'g') AS VARCHAR(5)),'0'),''),'1') AS INTEGER),'00000'))
    || TRIM(TO_CHAR(NOTASFISCAIS.NRONOTA,'000000000000000'))
    AS ID_DPS,
    Current_timestamp as dhProc,
    0 AS nNFSe,
    1 as tpEmis, --1==Sistema Próprio da Prefeitura;2==Sefin Webservice Nacional
    '100' as cStat
  FROM NOTASFISCAIS
  JOIN CONFIGURA ON CONFIGURA.CODHOTEL = NOTASFISCAIS.CODHOTEL
  JOIN CONFIGURA3 ON CONFIGURA3.CODHOTEL = NOTASFISCAIS.CODHOTEL
    WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
  AND NOTASFISCAIS.CODNOTA = :CDNOTA
  AND CONFIGURA3.CODIBGEHOTEL IN ('3530607')

  
