SELECT
       STRING_AGG(DESCRICAO_SERVICO, ' | ' ORDER BY FLCATEGORIA = 4, CDDOCFISCALITEM) AS DESCRICAO_SERVICO
FROM (
        SELECT
            MIN(DETNOTAFISCAL.DETCODNOTA) AS CDDOCFISCALITEM,
            CASE
                WHEN DETNOTAFISCAL.TIPOIMPOSTO = 'S' AND MAX(DETNOTAFISCAL.CODPRODUTO) IS NULL AND MAX(DETNOTAFISCAL.UNIDADE) IS NULL AND DETNOTAFISCAL.VALUNIT IS NULL
            THEN 4
            END AS FLCATEGORIA,
            DETNOTAFISCAL.CODNOTA AS CDDOCFISCAL,
            DETNOTAFISCAL.CODHOTEL AS CDEMPRESA,
            DETNOTAFISCAL.DESCRICAO
           ||
           CASE
                WHEN SUM(DETNOTAFISCAL.QTDE) > 1 AND SUM(DETNOTAFISCAL.QTDE) = CAST(SUM(DETNOTAFISCAL.QTDE) AS INTEGER) AND DETNOTAFISCAL.VALUNIT > 0
           THEN ''
            || ' - '
            || TRIM(TO_CHAR(DETNOTAFISCAL.VALUNIT, '999G999G999G990D00'))
            || ' x '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.QTDE), '999G999G999G990'))
                WHEN SUM(DETNOTAFISCAL.QTDE) > 1 AND DETNOTAFISCAL.VALUNIT > 0
           THEN ''
            || ' - '
            || TRIM(TO_CHAR(DETNOTAFISCAL.VALUNIT, '999G999G999G990D00'))
            || ' x '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.QTDE), '999G999G999G990D00'))
                WHEN SUM(DETNOTAFISCAL.QTDE) > 1 AND SUM(DETNOTAFISCAL.QTDE) = CAST(SUM(DETNOTAFISCAL.QTDE) AS INTEGER)
           THEN ''
            || ' - '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.VALTOTAL) / SUM(DETNOTAFISCAL.QTDE), '999G999G999G990D00'))
            || ' x '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.QTDE), '999G999G999G990'))
                WHEN SUM(DETNOTAFISCAL.QTDE) > 1
           THEN ''
            || ' - '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.VALTOTAL) / SUM(DETNOTAFISCAL.QTDE), '999G999G999G990D00'))
            || ' x '
            || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.QTDE), '999G999G999G990D00'))
           ELSE ''
            END
           || ' = '
           || TRIM(TO_CHAR(SUM(DETNOTAFISCAL.VALTOTAL), '999G999G999G990D00')) AS DESCRICAO_SERVICO
        FROM
            NOTASFISCAIS
        JOIN
           DETNOTAFISCAL ON DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA
            AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL
        WHERE
            NOTASFISCAIS.CODHOTEL = :CDEMPRESA
            AND NOTASFISCAIS.CODNOTA = :CDNOTA
        GROUP BY
            DETNOTAFISCAL.DESCRICAO,
            DETNOTAFISCAL.TIPOIMPOSTO,
            DETNOTAFISCAL.VALUNIT,
            DETNOTAFISCAL.CODNOTA,
            DETNOTAFISCAL.CODHOTEL,
            DETNOTAFISCAL.taxitem,
            DETNOTAFISCAL.taxaissitem,
            CASE
                WHEN DETNOTAFISCAL.CODPRODUTO = 0
           THEN DETNOTAFISCAL.VALTOTAL / DETNOTAFISCAL.QTDE
            END
        ORDER BY
            DETNOTAFISCAL.TIPOIMPOSTO = 'S' AND MAX(DETNOTAFISCAL.CODPRODUTO) IS NULL AND MAX(DETNOTAFISCAL.UNIDADE) IS NULL AND DETNOTAFISCAL.VALUNIT IS NULL,
            MIN(DETNOTAFISCAL.DETCODNOTA),
            DETNOTAFISCAL.DESCRICAO
    ) AS ITENS_NFE