SELECT
    STRING_AGG(DESCRICAO_SERVICO, ' | ' ORDER BY FLCATEGORIA = 4 DESC, CDDOCFISCALITEM) AS DESCRICAO_SERVICO
FROM (
    SELECT
        DET.DETCODNOTA AS CDDOCFISCALITEM,
        CASE
            WHEN DET.TIPOIMPOSTO = 'S' AND DET.CODPRODUTO IS NULL AND DET.UNIDADE IS NULL AND DET.VALUNIT IS NULL THEN 4
        END AS FLCATEGORIA,
        DET.CODNOTA AS CDDOCFISCAL,
        DET.CODHOTEL AS CDEMPRESA,
        DET.DESCRICAO ||
        CASE
            WHEN DET.QTDE > 1 AND DET.QTDE = CAST(DET.QTDE AS INTEGER) AND DET.VALUNIT > 0
                THEN ' - ' || TRIM(TO_CHAR(DET.VALUNIT, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990'))
            WHEN DET.QTDE > 1 AND DET.VALUNIT > 0
                THEN ' - ' || TRIM(TO_CHAR(DET.VALUNIT, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990D00'))
            WHEN DET.QTDE > 1 AND DET.QTDE = CAST(DET.QTDE AS INTEGER)
                THEN ' - ' || TRIM(TO_CHAR(DET.VALTOTAL / DET.QTDE, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990'))
            WHEN DET.QTDE > 1
                THEN ' - ' || TRIM(TO_CHAR(DET.VALTOTAL / DET.QTDE, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990D00'))
            ELSE ''
        END
        || ' = ' || TRIM(TO_CHAR(DET.VALTOTAL, '999G999G999G990D00')) AS DESCRICAO_SERVICO
    FROM (
        SELECT
            MIN(DETCODNOTA) AS DETCODNOTA,
            CODNOTA,
            CODHOTEL,
            DESCRICAO,
            TIPOIMPOSTO,
            VALUNIT,
            SUM(TAXITEM) AS TAXITEM,
            SUM(TAXAISSITEM) AS TAXAISSITEM,
            SUM(QTDE) AS QTDE,
            SUM(VALTOTAL) AS VALTOTAL,
            MAX(CODPRODUTO) AS CODPRODUTO,
            MAX(UNIDADE) AS UNIDADE
        FROM DETNOTAFISCAL
        WHERE CODHOTEL = :CDEMPRESA
          AND CODNOTA = :CDNOTA
        GROUP BY
            CODNOTA,
            CODHOTEL,
            DESCRICAO,
            TIPOIMPOSTO,
            VALUNIT
    ) AS DET
) AS ITENS_NFE;