SELECT
string_agg(DESCRICAO_SERVICO, ' | ' ORDER BY FLCATEGORIA=4,CDDOCFISCALITEM) AS DESCRICAO_SERVICO
FROM (
                    SELECT MIN(DETNOTAFISCAL.DETCODNOTA) AS CDDOCFISCALITEM,
                         CASE WHEN DETNOTAFISCAL.TIPOIMPOSTO='S' AND max(DETNOTAFISCAL.CODPRODUTO) IS NULL AND max(DETNOTAFISCAL.UNIDADE) IS NULL AND DETNOTAFISCAL.VALUNIT IS NULL THEN 4 END AS FLCATEGORIA,
                         DETNOTAFISCAL.CODNOTA AS CDDOCFISCAL,
                         DETNOTAFISCAL.CODHOTEL AS CDEMPRESA,
                         DETNOTAFISCAL.DESCRICAO
                         --COALESCE(DETNOTAFISCAL.QTDE, '1') 
                        ||CASE 
                        WHEN SUM(DETNOTAFISCAL.QTDE) > 1 AND SUM(DETNOTAFISCAL.QTDE) = CAST(SUM(DETNOTAFISCAL.QTDE) AS INTEGER) AND DETNOTAFISCAL.VALUNIT > 0
                        THEN ''
                         || ' - '||TRIM(to_char(DETNOTAFISCAL.VALUNIT,'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DETNOTAFISCAL.QTDE),'999G999G999G990'))
                        WHEN SUM(DETNOTAFISCAL.QTDE) > 1  AND DETNOTAFISCAL.VALUNIT > 0
                        THEN ''
                         || ' - '||TRIM(to_char(DETNOTAFISCAL.VALUNIT,'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DETNOTAFISCAL.QTDE),'999G999G999G990D00'))
                        WHEN SUM(DETNOTAFISCAL.QTDE) > 1 AND SUM(DETNOTAFISCAL.QTDE) = CAST(SUM(DETNOTAFISCAL.QTDE) AS INTEGER)
                        THEN ''
                         || ' - '||TRIM(to_char(SUM(DETNOTAFISCAL.VALTOTAL/DETNOTAFISCAL.QTDE),'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DETNOTAFISCAL.QTDE),'999G999G999G990'))
                        WHEN SUM(DETNOTAFISCAL.QTDE) > 1 
                        THEN ''
                         || ' - '||TRIM(to_char(SUM(DETNOTAFISCAL.VALTOTAL/DETNOTAFISCAL.QTDE),'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DETNOTAFISCAL.QTDE),'999G999G999G990D00'))
                         ELSE '' END
                         || ' = ' ||TRIM(to_char(SUM(DETNOTAFISCAL.VALTOTAL),'999G999G999G990D00'))
                         AS DESCRICAO_SERVICO       
  FROM NOTASFISCAIS
  JOIN DETNOTAFISCAL ON DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL
  WHERE NOTASFISCAIS.CODHOTEL = :CDEMPRESA
     AND NOTASFISCAIS.CODNOTA = :CDNOTA
            GROUP BY DETNOTAFISCAL.DESCRICAO,
            DETNOTAFISCAL.TIPOIMPOSTO,
            DETNOTAFISCAL.VALUNIT,
            DETNOTAFISCAL.CODNOTA,
            DETNOTAFISCAL.CODHOTEL,
            DETNOTAFISCAL.taxitem, 
            DETNOTAFISCAL.taxaissitem
            ORDER BY DETNOTAFISCAL.TIPOIMPOSTO='S' AND max(DETNOTAFISCAL.CODPRODUTO) IS NULL AND max(DETNOTAFISCAL.UNIDADE) IS NULL AND DETNOTAFISCAL.VALUNIT IS NULL,
            MIN(DETNOTAFISCAL.DETCODNOTA),
            DETNOTAFISCAL.DESCRICAO
) ITENS_NFE