SELECT
    STRING_AGG(DESCRICAO_SERVICO, ' | ' ORDER BY FLCATEGORIA = 4, CDDOCFISCALITEM) AS DESCRICAO_SERVICO
FROM (
    SELECT
        DET.DETCODNOTA AS CDDOCFISCALITEM,
        CASE
            WHEN DET.TIPOIMPOSTO = 'S' AND DET.CODPRODUTO IS NULL AND DET.VALUNIT IS NULL THEN 4
            ELSE 0
        END AS FLCATEGORIA,
        DET.CODNOTA AS CDDOCFISCAL,
        DET.CODHOTEL AS CDEMPRESA,
        DET.DESCRICAO
        || CASE
            WHEN DET.QTDE > 1 AND DET.QTDE = CAST(DET.QTDE AS INTEGER)
                THEN ' - ' || TRIM(TO_CHAR(DET.VALUNIT, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990'))
            WHEN DET.QTDE > 1
                THEN ' - ' || TRIM(TO_CHAR(DET.VALUNIT, '999G999G999G990D00')) || ' X ' || TRIM(TO_CHAR(DET.QTDE, '999G999G999G990D00'))
            ELSE ''
        END
        || ' = ' || TRIM(TO_CHAR(DET.VALTOTAL, '999G999G999G990D00'))
        AS DESCRICAO_SERVICO
    FROM (
        SELECT
            MIN(DETCODNOTA) AS DETCODNOTA,
            CODNOTA, CODHOTEL,
            DESCRICAO,
            TIPOIMPOSTO,
            CASE WHEN VALUNIT > 0 THEN VALUNIT ELSE VALTOTAL END AS VALUNIT,
            --SUM(TAXITEM) AS TAXITEM,
            --SUM(TAXAISSITEM) AS TAXAISSITEM,
            --MAX(UNIDADE) AS UNIDADE,
            MAX(CODPRODUTO) AS CODPRODUTO,
            SUM(COALESCE(QTDE,1)) AS QTDE,
            SUM(VALTOTAL) AS VALTOTAL
        FROM DETNOTAFISCAL
        WHERE CODHOTEL = :CDEMPRESA
          AND CODNOTA = :CDNOTA
        GROUP BY CODNOTA, CODHOTEL,
            DESCRICAO,
            TIPOIMPOSTO,
            CASE WHEN VALUNIT > 0 THEN VALUNIT ELSE VALTOTAL END 
    ) AS DET
) AS ITENS_NFE;