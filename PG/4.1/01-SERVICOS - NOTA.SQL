/* Gerador NFS-e Nacional
* VersÃ£o==1.0
* Gerada em==06/01/2026;
* ENFE==17.07+;
* PostGreSQL==12+;
* Gerencia Hoteleira 4.1/3.1==10.97+
*/
SELECT NOTASFISCAIS.CODNOTA AS CDDOCFISCAL,
    NOTASFISCAIS.TOTALNOTA AS VLTOTAL,
    (SELECT SUM(VALTOTAL) FROM DETNOTAFISCAL 
              WHERE DETNOTAFISCAL.TIPOIMPOSTO IN ('S') AND DETNOTAFISCAL.ALIQUOTA = 0
              AND DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
              AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL) AS VLDEDUCOES,
    NOTASFISCAIS.TOTALNOTA -
    (SELECT SUM(VALTOTAL) FROM DETNOTAFISCAL 
              WHERE DETNOTAFISCAL.TIPOIMPOSTO IN ('S') AND DETNOTAFISCAL.ALIQUOTA = 0
              AND DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
              AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL) AS VLBASEISS,
    NOTASFISCAIS.TOTALPROD AS VLTOTALPRODUTO,
    NOTASFISCAIS.TOTALSERV AS VLTOTALSERVICO,
    NOTASFISCAIS.TOTALNOTA AS VALORRECEBIDO,
    COALESCE((SELECT SUM(DESCITEM) FROM DETNOTAFISCAL 
              WHERE DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
              AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL),0) AS VLDESCONTO,
    0.00 AS VLDESCONTOCONDICIONADO, 
    CASE WHEN NOTASFISCAIS.VALISSRET > 0 
      THEN 1 
      ELSE 0 
    END AS TEM_ISS_RETIDO,
    CASE PISCOFINS.CSTPISCOFINS
      WHEN '00' THEN 0
      WHEN '01' THEN 1
      WHEN '02' THEN 2
      WHEN '03' THEN 3
      WHEN '04' THEN 4
      WHEN '05' THEN 5
      WHEN '06' THEN 6
      WHEN '07' THEN 7
      WHEN '08' THEN 8
      WHEN '09' THEN 9
    END AS CSTPISCOFINS,
    CASE 
      WHEN PISCOFINS.CSTPISCOFINS NOT IN ('01','08','09') 
      THEN PISCOFINS.BASEPIS 
    END AS BASEPIS,
    PISCOFINS.ALIQPIS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQPIS /100,2) AS VALPIS_ITEM,
    PISCOFINS.ALIQCOFINS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQCOFINS /100,2) AS VALCOFINS_ITEM,
    CASE 
      WHEN COALESCE(NOTASFISCAIS.VALPISRET,0) + COALESCE(NOTASFISCAIS.VALCOFINSRET,0) > 0 THEN 0 
      WHEN COALESCE(NOTASFISCAIS.VALORPIS,0) + COALESCE(NOTASFISCAIS.VALORCOFINS,0) > 0 THEN 1 
      ELSE 2 
    END AS TEM_PISCOFIN_RETIDO,
    COALESCE(NULLIF(NOTASFISCAIS.VALPISRET,0),NOTASFISCAIS.VALORPIS,0) AS VALPISRET,
    COALESCE(NULLIF(NOTASFISCAIS.VALCOFINSRET,0),NOTASFISCAIS.VALORCOFINS,0) AS VALCOFINSRET,
    0 AS VALINSSRET,
    COALESCE(NOTASFISCAIS.VALIRRET,0) AS VALIRRET,
    COALESCE(NOTASFISCAIS.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(NOTASFISCAIS.VALISSRET,0) AS VALISSRET,
    NOTASFISCAIS.VLIBPT+NOTASFISCAIS.VLIBPTEST+NOTASFISCAIS.VLIBPTMUN  AS TOTALAPROXTRIB,
    NOTASFISCAIS.VLIBPTEST ,
    NOTASFISCAIS.PCALIQIBPTEST, 
    NOTASFISCAIS.VLIBPTMUN,
    NOTASFISCAIS.PCALIQIBPTMUN, 
    NOTASFISCAIS.VLIBPT AS VLIBPTFED,
    NOTASFISCAIS.PCALIQIBPT AS PCIBPTFED,
    NOTASFISCAIS.DSOBSIBPT
  FROM NOTASFISCAIS
  JOIN NFERETORNO ON NOTASFISCAIS.CODNOTA = NFERETORNO.CDNOTA AND NOTASFISCAIS.CODHOTEL = NFERETORNO.CDEMPRESA
  LEFT JOIN (SELECT DETNOTAFISCAL.CODNOTA,
        DETNOTAFISCAL.CODHOTEL,
        MAX(CASE WHEN DETNOTAFISCAL.CSTPIS = DETNOTAFISCAL.CSTCOFINS THEN DETNOTAFISCAL.CSTPIS END ) AS CSTPISCOFINS,
        SUM(DETNOTAFISCAL.BASEPIS) AS BASEPIS,
        AVG(DETNOTAFISCAL.ALIQPIS) AS ALIQPIS,
        SUM(DETNOTAFISCAL.VALPIS ) AS VALPIS_ITEM,
        AVG(DETNOTAFISCAL.ALIQCOFINS) AS ALIQCOFINS,
        SUM(DETNOTAFISCAL.VALCOFINS ) AS VALCOFINS_ITEM
        FROM DETNOTAFISCAL 
        WHERE DETNOTAFISCAL.CODHOTEL = :CDEMPRESA
          AND DETNOTAFISCAL.CODNOTA = :CDNOTA
          AND DETNOTAFISCAL.VALPIS>0 AND DETNOTAFISCAL.VALCOFINS>0
        GROUP BY DETNOTAFISCAL.CODNOTA, DETNOTAFISCAL.CODHOTEL
  ) AS PISCOFINS ON NOTASFISCAIS.CODNOTA = PISCOFINS.CODNOTA AND NOTASFISCAIS.CODHOTEL = PISCOFINS.CODHOTEL 
  WHERE NFERETORNO.CDEMPRESA = :CDEMPRESA
  AND NFERETORNO.CDNOTA = :CDNOTA
  AND NFERETORNO.FLTIPONOTA = 1 