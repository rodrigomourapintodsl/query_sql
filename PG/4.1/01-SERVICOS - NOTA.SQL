/* Gerador NFS-e Nacional
* VersÃ£o==1.0
* Gerada em==15/12/2025;
* ENFE==17.07+;
* PostGreSQL==12+;
* Gerencia Hoteleira 4.1/3.1==10.97+
*/
SELECT NOTASFISCAIS.CODNOTA AS CDDOCFISCAL,
    NOTASFISCAIS.TOTALNOTA AS vltotal,
    (SELECT SUM(VALTOTAL) FROM DETNOTAFISCAL 
              WHERE DETNOTAFISCAL.tipoimposto IN ('S') AND DETNOTAFISCAL.aliquota = 0
              AND DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
              AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL) AS vldeducoes,
    NOTASFISCAIS.totalprod AS vltotalproduto,
    NOTASFISCAIS.totalserv AS vltotalservico,
    NOTASFISCAIS.TOTALNOTA AS ValorRecebido,
    COALESCE((SELECT SUM(descitem) FROM DETNOTAFISCAL 
              WHERE DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
              AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL),0) AS vldesconto,
    0.00 AS vlDESCONTOCONDICIONADO, 
    CASE WHEN NOTASFISCAIS.VALISSRET > 0 
      THEN 1 ELSE 0 
    END as TEM_ISS_RETIDO,
    CASE piscofins.cstpiscofins
          WHEN '00' THEN 0
          WHEN '01' THEN 1
          WHEN '02' THEN 2
          WHEN '03' THEN 3
          WHEN '04' THEN 4
          WHEN '05' THEN 5
          WHEN '06' THEN 6
          WHEN '07' THEN 7
          WHEN '08' THEN 8
          WHEN '09' THEN 9
        END AS cstpiscofins,
    case 
      when piscofins.cstpiscofins not in ('01','08','09') 
      then piscofins.basepis 
    end as basepis,
    piscofins.aliqpis,
    piscofins.valpis_item,
    piscofins.aliqcofins,
    piscofins.valcofins_item,
    CASE 
      WHEN COALESCE(NOTASFISCAIS.VALPISRET,0) + COALESCE(NOTASFISCAIS.VALCOFINSRET,0) > 0 THEN 0 
      WHEN COALESCE(NOTASFISCAIS.valorpis,0) + COALESCE(NOTASFISCAIS.valorcofins,0) > 0 THEN 1 
      ELSE 2 
    END as TEM_PISCOFIN_RETIDO,
    COALESCE(NULLIF(NOTASFISCAIS.VALPISRET,0),notasfiscais.valorpis,0) AS VALPISRET,
    COALESCE(NULLIF(NOTASFISCAIS.VALCOFINSRET,0),notasfiscais.valorcofins,0) AS VALCOFINSRET,
    0 AS VALINSSRET,
    COALESCE(NOTASFISCAIS.VALIRRET,0) AS VALIRRET,
    COALESCE(NOTASFISCAIS.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(NOTASFISCAIS.VALISSRET,0) AS VALISSRET,
    NOTASFISCAIS.vlibpt+NOTASFISCAIS.vlibptest+NOTASFISCAIS.vlibptmun  AS totalAproxTrib,
    NOTASFISCAIS.vlibptest ,
    NOTASFISCAIS.pcaliqibptest, 
    NOTASFISCAIS.vlibptmun,
    NOTASFISCAIS.pcaliqibptmun, 
    NOTASFISCAIS.vlibpt AS vlibptFed,
    NOTASFISCAIS.pcaliqibpt AS pcibptFed,
    NOTASFISCAIS.dsobsibpt
  FROM NOTASFISCAIS
  JOIN NFERETORNO ON NOTASFISCAIS.CODNOTA = NFERETORNO.CDNOTA AND NOTASFISCAIS.CODHOTEL = NFERETORNO.CDEMPRESA
  LEFT JOIN (SELECT DETNOTAFISCAL.CODNOTA,
        DETNOTAFISCAL.CODHOTEL,
        max(CASE WHEN DETNOTAFISCAL.cstpis = DETNOTAFISCAL.cstcofins THEN DETNOTAFISCAL.cstpis END ) AS cstpiscofins,
        sum(DETNOTAFISCAL.basepis) AS basepis,
        avg(DETNOTAFISCAL.aliqpis) AS aliqpis,
        sum(DETNOTAFISCAL.valpis ) AS valpis_item,
        avg(DETNOTAFISCAL.aliqcofins) AS aliqcofins,
        sum(DETNOTAFISCAL.valcofins ) AS valcofins_item
        FROM DETNOTAFISCAL 
        WHERE DETNOTAFISCAL.CODHOTEL = :CDEMPRESA
          AND DETNOTAFISCAL.CODNOTA = :CDNOTA
          AND DETNOTAFISCAL.valpis>0 AND DETNOTAFISCAL.valcofins>0
        GROUP BY DETNOTAFISCAL.CODNOTA, DETNOTAFISCAL.CODHOTEL
  ) AS piscofins ON NOTASFISCAIS.CODNOTA = piscofins.CODNOTA AND NOTASFISCAIS.CODHOTEL = piscofins.CODHOTEL 
  WHERE NFERETORNO.CDEMPRESA = :CDEMPRESA
  AND NFERETORNO.CDNOTA = :CDNOTA
  AND NFERETORNO.fltiponota = 1 