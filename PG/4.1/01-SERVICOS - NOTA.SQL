/* Gerador NFS-e Nacional
* VersÃ£o==1.0
* Gerada em==11/12/2025;
* ENFE==17.07+;
* PostGreSQL==12+;
* Gerencia Hoteleira 4.1/3.1==10.97+
*/
SELECT NOTASFISCAIS.CODNOTA AS CDDOCFISCAL,
NOTASFISCAIS.TOTALNOTA AS vltotal,
(SELECT SUM(VALTOTAL) FROM DETNOTAFISCAL 
          WHERE DETNOTAFISCAL.tipoimposto IN ('S') AND DETNOTAFISCAL.aliquota = 0
          AND DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
          AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL) AS vldeducoes,
NOTASFISCAIS.totalprod AS vltotalproduto,
NOTASFISCAIS.totalserv AS vltotalservico,
NOTASFISCAIS.TOTALNOTA AS ValorRecebido,
COALESCE((SELECT SUM(descitem) FROM DETNOTAFISCAL 
          WHERE DETNOTAFISCAL.CODNOTA = NOTASFISCAIS.CODNOTA 
          AND DETNOTAFISCAL.CODHOTEL = NOTASFISCAIS.CODHOTEL),0) AS vldesconto,
0.00 AS vlDESCONTOCONDICIONADO, 
CASE WHEN NOTASFISCAIS.VALISSRET > 0 THEN 1 ELSE 0 END as TEM_ISS_RETIDO,
CASE 
WHEN COALESCE(NOTASFISCAIS.VALPISRET,NOTASFISCAIS.VALCOFINSRET,0) > 0 THEN 0 
WHEN COALESCE(NOTASFISCAIS.valorpis,NOTASFISCAIS.valorcofins,0) > 0 THEN 1 
ELSE 2 END as TEM_PISCOFIN_RETIDO,
(SELECT sum(DETNOTAFISCAL.basepis) FROM DETNOTAFISCAL 
        WHERE DETNOTAFISCAL.CODHOTEL = :CDEMPRESA
          AND DETNOTAFISCAL.CODNOTA = :CDNOTA
) AS pcbasepis, 
    COALESCE(NOTASFISCAIS.VALPISRET,notasfiscais.valorpis,0) AS VALPISRET,
    COALESCE(NOTASFISCAIS.VALCOFINSRET,notasfiscais.valorcofins,0) AS VALCOFINSRET,
    0 AS VALINSSRET,
    COALESCE(NOTASFISCAIS.VALIRRET,0) AS VALIRRET,
    COALESCE(NOTASFISCAIS.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(NOTASFISCAIS.VALISSRET,0) AS VALISSRET,
    NOTASFISCAIS.vlibpt+NOTASFISCAIS.vlibptest+NOTASFISCAIS.vlibptmun  AS totalAproxTrib,
    NOTASFISCAIS.vlibptest ,
    NOTASFISCAIS.pcaliqibptest, 
    NOTASFISCAIS.vlibptmun,
    NOTASFISCAIS.pcaliqibptmun, 
    NOTASFISCAIS.vlibpt AS vlibptFed,
    NOTASFISCAIS.pcaliqibpt AS pcibptFed,
    NOTASFISCAIS.dsobsibpt
  FROM NOTASFISCAIS
  JOIN NFERETORNO ON NOTASFISCAIS.CODNOTA = NFERETORNO.CDNOTA AND NOTASFISCAIS.CODHOTEL = NFERETORNO.CDEMPRESA
  WHERE NFERETORNO.CDEMPRESA = :CDEMPRESA
  AND NFERETORNO.CDNOTA = :CDNOTA
  AND NFERETORNO.fltiponota = 1 