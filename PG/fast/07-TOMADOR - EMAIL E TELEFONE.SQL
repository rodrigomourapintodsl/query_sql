SELECT EMAIL,EMAIL_DESTINATARIO,TELEFONE FROM (
SELECT ROW_NUMBER() OVER(ORDER BY ID) AS IDEMAIL,
    EMAIL,
    EMAIL_DESTINATARIO
FROM (
--remover caracteres especiais
SELECT EMAILS AS EMAILS 
    ,TRIM(
        REGEXP_REPLACE(
            SPLIT_PART(EMAIL, ';', 1),
            '[^abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\@\.\;\_\-]',
            '',
            'g'
        )
    ) AS EMAIL,STRING_AGG(EMAIL,';') OVER() AS EMAIL_DESTINATARIO,
    ROW_NUMBER() OVER(
        ORDER BY MIN(ID)
    ) AS ID
FROM (
--split nome definido <>
        SELECT ID
            ,COALESCE(
                (regexp_match(EMAIL, '<(.*)>'))[1],
                EMAIL
            ) AS EMAIL,
            EMAILS
        FROM (
--adicionar ordem
                SELECT ROW_NUMBER() OVER() AS ID 
                    ,*
                FROM (
--split multiplos emails ;
                        SELECT 
                            EMAIL AS EMAILS,
                            regexp_split_to_table(EMAIL, ';') AS EMAIL
                        FROM (
-- unindo registros
                                SELECT string_agg(EMAIL, ';') AS EMAIL 
                                FROM (
--query normal da tabela de emails
SELECT PESSOACONTATO.dsemailpessoa AS EMAIL
FROM DOCFISCAL
  JOIN PESSOA ON PESSOA.CDPESSOA = DOCFISCAL.CDPESSOA
  JOIN PESSOAENDERECO ON PESSOAENDERECO.CDPESSOA = PESSOA.CDPESSOA AND PESSOAENDERECO.NRTIPOENDERECO = 0
  JOIN PESSOACONTATO ON PESSOAENDERECO.CDPESSOAENDERECO = PESSOACONTATO.CDPESSOAENDERECO AND PESSOACONTATO.FLENDERECO = 1
WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
ORDER BY CDPESSOACONTATO
                                    ) AS NOTASFISCAIS
                            ) AS CONTATO_EMAIL_UNINDO
                    ) AS CONTATO_EMAIL_MULTIPLOS
            ) AS CONTATO_EMAIL_ORDEM
    ) AS CONTATO_EMAIL_NOME_DEFINIDO
WHERE CHAR_LENGTH(EMAIL) >= 10
    AND EMAIL LIKE '%@%.%'
    AND TRIM(SPLIT_PART(EMAIL, ';', 1)) NOT LIKE '% %'
    AND EMAIL NOT LIKE '%<%'
    AND EMAIL NOT LIKE '%>%'
    AND EMAIL NOT LIKE '%,%'
    AND EMAIL NOT LIKE '%"%'
    AND EMAIL NOT LIKE '%''%'
    AND EMAIL NOT LIKE '%@%@%'
    AND EMAIL NOT LIKE '%@.%'
    AND EMAIL NOT LIKE '%@.%'
    AND EMAIL NOT LIKE '%@'
    AND EMAIL NOT LIKE '@%'
    AND EMAIL NOT LIKE '%..%'
    AND EMAIL NOT LIKE '%.'
    AND EMAIL NOT LIKE '.%' 
    AND LEFT(TRIM(EMAIL),-1) NOT LIKE '%;%'
    AND EMAIL NOT SIMILAR TO '%[ŠŽšžŸÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖÙÚÛÜÝàáâãäåçèéêëìíîïðñòóôõöùúûüýÿ]%'
GROUP BY EMAIL,
    EMAILS
) AS T
ORDER BY ID
) AS E
FULL OUTER JOIN (
SELECT ROW_NUMBER() OVER(ORDER BY CDPESSOACONTATO) AS IDFONE,
   CASE WHEN PESSOACONTATO.idtelefone LIKE '+55%' 
       THEN REGEXP_REPLACE(RIGHT(PESSOACONTATO.idtelefone,-3),'[^0-9]','','g')
       ELSE  regexp_replace(PESSOACONTATO.idtelefone, '[^0-9]', '', 'g')
   END  AS telefone
FROM DOCFISCAL
  JOIN PESSOA ON PESSOA.CDPESSOA = DOCFISCAL.CDPESSOA
  JOIN PESSOAENDERECO ON PESSOAENDERECO.CDPESSOA = PESSOA.CDPESSOA AND PESSOAENDERECO.NRTIPOENDERECO = 0
  JOIN PESSOACONTATO ON PESSOAENDERECO.CDPESSOAENDERECO = PESSOACONTATO.CDPESSOAENDERECO AND PESSOACONTATO.FLENDERECO = 1
WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
  AND (LENGTH(PESSOACONTATO.idtelefone) BETWEEN 8 AND 14 
    OR LENGTH(PESSOACONTATO.idtelefone) BETWEEN 8 AND 20 AND PESSOACONTATO.idtelefone LIKE '+%'
    )
ORDER BY CDPESSOACONTATO
) AS F ON IDFONE=IDEMAIL
WHERE IDFONE IS NOT NULL OR IDEMAIL IS NOT NULL 
ORDER BY IDEMAIL