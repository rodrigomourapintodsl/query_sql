/* Gerador NFS-e Nacional
* Versão==1.0
* Gerada em==06/01/2025;
* ENFE==17.07+;
* PostGreSQL==12+;
* Fast BackOffice==10.139.1+
*/
SELECT DOCFISCAL.CDDOCFISCAL,
    DOCFISCAL.VLTOTAL,
   (SELECT SUM(VLTOTAL) FROM DOCFISCALITEM 
          WHERE DOCFISCALITEM.FLCATEGORIA IN (2) AND DOCFISCALITEM.PCISS='0' AND DOCFISCALITEM.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL 
          AND DOCFISCALITEM.CDEMPRESA = DOCFISCAL.CDEMPRESA) AS VLDEDUCOES,
    DOCFISCAL.VLTOTALPRODUTO,
    DOCFISCAL.VLTOTALSERVICO,
    DOCFISCAL.VLTOTAL AS VALORRECEBIDO,
    DOCFISCAL.VLDESCONTO,
    0.00 AS VLDESCONTOCONDICIONADO, 
    CASE WHEN RETENCAO.VALISSRET > 0 
      THEN 1 
      ELSE 0 
    END AS TEM_ISS_RETIDO,
    CASE PISCOFINS.CSTPISCOFINS
      WHEN '00' THEN 0
      WHEN '01' THEN 1
      WHEN '02' THEN 2
      WHEN '03' THEN 3
      WHEN '04' THEN 4
      WHEN '05' THEN 5
      WHEN '06' THEN 6
      WHEN '07' THEN 7
      WHEN '08' THEN 8
      WHEN '09' THEN 9
    END AS CSTPISCOFINS,
    CASE 
      WHEN PISCOFINS.CSTPISCOFINS NOT IN ('01','08','09') 
      THEN PISCOFINS.BASEPIS 
    END AS BASEPIS,
    PISCOFINS.ALIQPIS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQPIS /100,2) AS VALPIS_ITEM,
    PISCOFINS.VALPIS_ITEM,
    PISCOFINS.ALIQCOFINS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQCOFINS /100,2) AS VALCOFINS_ITEM,
    CASE 
        WHEN COALESCE(RETENCAO.VALPISRET,0) + COALESCE(RETENCAO.VALCOFINSRET,0) >0 THEN 0 
        WHEN DOCFISCAL.VLTOTALPIS + DOCFISCAL.VLTOTALCOFINS >0 THEN 1
        ELSE 2 
    END AS TEM_PISCOFIN_RETIDO,
    COALESCE(RETENCAO.VALPISRET,0) AS VALPISRET,
    COALESCE(RETENCAO.VALCOFINSRET,0) AS VALCOFINSRET,
    COALESCE(RETENCAO.VALINSSRET,0) AS VALINSSRET,
    COALESCE(RETENCAO.VALIRRET,0) AS VALIRRET,
    COALESCE(RETENCAO.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(RETENCAO.VALISSRET,0) AS VALISSRET,
    DOCFISCAL.VLIBPT+DOCFISCAL.VLIBPTEST+DOCFISCAL.VLIBPTMUN AS TOTALAPROXTRIB,
    DOCFISCAL.VLIBPTEST ,
    DOCFISCAL.PCALIQIBPTEST, 
    DOCFISCAL.VLIBPTMUN,
    DOCFISCAL.PCALIQIBPTMUN, 
    DOCFISCAL.VLIBPT AS VLIBPTFED,
    DOCFISCAL.PCALIQIBPT AS PCIBPTFED,
    DOCFISCAL.DSOBSIBPT
  FROM DOCFISCAL
  JOIN NFERETORNO ON DOCFISCAL.CDDOCFISCAL = NFERETORNO.CDNOTA AND DOCFISCAL.CDEMPRESA = NFERETORNO.CDEMPRESA
  LEFT JOIN (
  SELECT DOCFISCALITEM.CDEMPRESA,DOCFISCALITEM.CDDOCFISCAL,
        MAX(CASE WHEN DOCFISCALITEM.IDCSTPIS = DOCFISCALITEM.IDCSTCOFINS THEN DOCFISCALITEM.IDCSTPIS END ) AS CSTPISCOFINS,
        SUM(DOCFISCALITEM.VLBASEPIS) AS BASEPIS,
        AVG(DOCFISCALITEM.PCPIS) AS ALIQPIS,
        SUM(DOCFISCALITEM.VLPIS ) AS VALPIS_ITEM,
        AVG(DOCFISCALITEM.PCCOFINS) AS ALIQCOFINS,
        SUM(DOCFISCALITEM.VLCOFINS ) AS VALCOFINS_ITEM
  FROM DOCFISCALITEM
  WHERE DOCFISCALITEM.CDEMPRESA = :CDEMPRESA
  AND DOCFISCALITEM.CDDOCFISCAL = :CDNOTA
          AND DOCFISCALITEM.VLPIS>0 AND DOCFISCALITEM.VLCOFINS>0
        GROUP BY DOCFISCALITEM.CDEMPRESA,DOCFISCALITEM.CDDOCFISCAL
  ) AS PISCOFINS ON DOCFISCAL.CDDOCFISCAL = PISCOFINS.CDDOCFISCAL AND DOCFISCAL.CDEMPRESA = PISCOFINS.CDEMPRESA 
  LEFT JOIN ( SELECT
    RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA,
    COALESCE( SUM(RETENCAO.VLPIS)      FILTER (WHERE RETENCAO.FLTRIBUTO IN (5   )), 0) AS VALPISRET, --06–PIS/PASEP
    COALESCE( SUM(RETENCAO.VLCOFINS)   FILTER (WHERE RETENCAO.FLTRIBUTO IN (6   )), 0) AS VALCOFINSRET, --07–COFINS
    COALESCE( SUM(RETENCAO.VLCSLL    ) FILTER (WHERE RETENCAO.FLTRIBUTO IN (   4)), 0) AS VALCSLLRET, --05–CSLL
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  14)), 0) AS VALINSSRET, --15-INSS
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN ( 0,1)), 0) AS VALIRRET, --01–IRPJ--02–IRRF
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  13)), 0) AS VALISSRET --14-ISSQN
    FROM RETENCAO 
    JOIN IMPOSTOFEDERAL ON IMPOSTOFEDERAL.CDIMPOSTOFEDERAL = RETENCAO.CDIMPOSTOFEDERAL
    WHERE RETENCAO.CDEMPRESA = :CDEMPRESA
    AND RETENCAO.CDDOCFISCAL = :CDNOTA
    GROUP BY RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA
  ) AS RETENCAO ON RETENCAO.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL AND RETENCAO.CDEMPRESA = DOCFISCAL.CDEMPRESA 
  WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
  AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
  AND NFERETORNO.FLTIPONOTA = 1 