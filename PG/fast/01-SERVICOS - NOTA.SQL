/* Gerador NFS-e Nacional
* Versão==1.0
* Gerada em==11/12/2025;
* ENFE==17.07+;
* PostGreSQL==12+;
* Fast BackOffice==10.139.1+
*/
SELECT DOCFISCAL.CDDOCFISCAL,
    DOCFISCAL.vltotal,
   (SELECT SUM(VLTOTAL) FROM DOCFISCALITEM 
          WHERE DOCFISCALITEM.FLCATEGORIA IN (2) AND DOCFISCALITEM.PCISS='0' AND DOCFISCALITEM.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL 
          AND DOCFISCALITEM.CDEMPRESA = DOCFISCAL.CDEMPRESA) AS vldeducoes,
    DOCFISCAL.vltotalproduto,
    DOCFISCAL.vltotalservico,
    DOCFISCAL.vltotal AS ValorRecebido,
    DOCFISCAL.vldesconto,
    0.00 AS vlDESCONTOCONDICIONADO, 
    CASE WHEN RETENCAO.VALISSRET > 0 THEN 1 ELSE 0 END as TEM_ISS_RETIDO,
    CASE WHEN COALESCE(RETENCAO.VALPISRET,0) + COALESCE(RETENCAO.VALCOFINSRET,0) >0 THEN 0 ELSE 2 END as TEM_PISCOFIN_RETIDO,
    COALESCE(RETENCAO.VALPISRET,0) AS VALPISRET,
    COALESCE(RETENCAO.VALCOFINSRET,0) AS VALCOFINSRET,
    COALESCE(RETENCAO.VALINSSRET,0) AS VALINSSRET,
    COALESCE(RETENCAO.VALIRRET,0) AS VALIRRET,
    COALESCE(RETENCAO.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(RETENCAO.VALISSRET,0) AS VALISSRET,
    DOCFISCAL.vlibpt+DOCFISCAL.vlibptest+DOCFISCAL.vlibptmun AS totalAproxTrib,
    DOCFISCAL.vlibptest ,
    DOCFISCAL.pcaliqibptest, 
    DOCFISCAL.vlibptmun,
    DOCFISCAL.pcaliqibptmun, 
    DOCFISCAL.vlibpt AS vlibptFed,
    DOCFISCAL.pcaliqibpt AS pcibptFed,
    docfiscal.dsobsibpt
  FROM DOCFISCAL
  JOIN NFERETORNO ON DOCFISCAL.CDDOCFISCAL = NFERETORNO.CDNOTA AND DOCFISCAL.CDEMPRESA = NFERETORNO.CDEMPRESA
  LEFT JOIN ( SELECT
    RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA,
    COALESCE( SUM(RETENCAO.VLPIS)      FILTER (WHERE RETENCAO.FLTRIBUTO IN (5   )), 0) AS VALPISRET, --06–PIS/PASEP
    COALESCE( SUM(RETENCAO.VLCOFINS)   FILTER (WHERE RETENCAO.FLTRIBUTO IN (6   )), 0) AS VALCOFINSRET, --07–COFINS
    COALESCE( SUM(RETENCAO.vlcsll    ) FILTER (WHERE RETENCAO.FLTRIBUTO IN (   4)), 0) AS VALCSLLRET, --05–CSLL
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  14)), 0) AS VALINSSRET, --15-INSS
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN ( 0,1)), 0) AS VALIRRET, --01–IRPJ--02–IRRF
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  13)), 0) AS VALISSRET --14-ISSQN
    FROM RETENCAO 
    JOIN impostofederal ON impostofederal.cdimpostofederal = RETENCAO.cdimpostofederal
    WHERE RETENCAO.CDEMPRESA = :CDEMPRESA
    AND RETENCAO.CDDOCFISCAL = :CDNOTA
    GROUP BY RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA
  ) AS RETENCAO ON RETENCAO.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL AND RETENCAO.CDEMPRESA = DOCFISCAL.CDEMPRESA 
  WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
  AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
  AND NFERETORNO.fltiponota = 1 