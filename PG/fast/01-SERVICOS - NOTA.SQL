/* Gerador NFS-e Nacional
* Versão==1.0
* Gerada em==15/01/2026;
* ENFE==17.10+;
* PostGreSQL==12+;
* Fast BackOffice==10.139.1+
*/
SELECT DOCFISCAL.CDDOCFISCAL,
    DOCFISCAL.VLTOTAL,
/*
   (SELECT SUM(VLTOTAL) FROM DOCFISCALITEM 
          WHERE DOCFISCALITEM.FLCATEGORIA IN (2) AND DOCFISCALITEM.PCISS=0
          AND DOCFISCALITEM.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL 
          AND DOCFISCALITEM.CDEMPRESA = DOCFISCAL.CDEMPRESA) AS VLDEDUCOES,
*/
    0 AS VLDEDUCOES,
    (SELECT sum(DOCFISCALITEM.vlbaseiss) FROM DOCFISCALITEM 
      WHERE CDEMPRESA = :CDEMPRESA
      AND CDDOCFISCAL = :CDNOTA
    ) AS vlbaseiss,
    DOCFISCAL.VLTOTALPRODUTO,
    --DOCFISCAL.VLTOTALSERVICO,
    DOCFISCAL.VLTOTAL
    +COALESCE(DOCFISCAL.VLDESCONTO ,0)
    +COALESCE(RETENCAO.VALCOFINSRET ,0)
    +COALESCE(RETENCAO.VALPISRET ,0)
    +COALESCE(RETENCAO.VALISSRET ,0)
    +COALESCE(RETENCAO.VALCSLLRET ,0)
    +COALESCE(RETENCAO.VALIRRET ,0)
    --NOTASFISCAIS.TOTALSERV AS VLTOTALSERVICO,
    /*
    Valor líquido = Valor do serviço 
    - Desconto condicionado 
    - Desconto incondicionado 
    - Valores retidos (CP, IRRF, CSLL) 
    - Valores retidos (ISSQN, PIS, COFINS)
    */ 
    AS VLTOTALSERVICO,
    DOCFISCAL.VLTOTAL AS VALORRECEBIDO,
    DOCFISCAL.VLDESCONTO,
    0.00 AS VLDESCONTOCONDICIONADO, 
    CASE WHEN RETENCAO.VALISSRET > 0 
      THEN 1 
      ELSE 0 
    END AS TEM_ISS_RETIDO,
    CASE PISCOFINS.CSTPISCOFINS
      WHEN '00' THEN 0
      WHEN '01' THEN 1
      WHEN '02' THEN 2
      WHEN '03' THEN 3
      WHEN '04' THEN 4
      WHEN '05' THEN 5
      WHEN '06' THEN 6
      WHEN '07' THEN 7
      WHEN '08' THEN 8
      WHEN '09' THEN 9
    END AS CSTPISCOFINS,
    CASE 
      WHEN PISCOFINS.CSTPISCOFINS NOT IN ('01','08','09') 
      THEN PISCOFINS.BASEPIS 
    END AS BASEPIS,
    PISCOFINS.ALIQPIS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQPIS )/100 AS VALPIS_ITEM,
    PISCOFINS.ALIQCOFINS,
    ROUND(PISCOFINS.BASEPIS * PISCOFINS.ALIQCOFINS )/100 AS VALCOFINS_ITEM,
    CASE 
        WHEN COALESCE(RETENCAO.VALPISRET,0) + COALESCE(RETENCAO.VALCOFINSRET,0) >0 THEN 0 
        WHEN DOCFISCAL.VLTOTALPIS + DOCFISCAL.VLTOTALCOFINS >0 THEN 1
        ELSE 2 
    END AS TEM_PISCOFIN_RETIDO,
    COALESCE(RETENCAO.VALPISRET,0) AS VALPISRET,
    COALESCE(RETENCAO.VALCOFINSRET,0) AS VALCOFINSRET,
    COALESCE(RETENCAO.VALINSSRET,0) AS VALINSSRET,
    COALESCE(RETENCAO.VALIRRET,0) AS VALIRRET,
    COALESCE(RETENCAO.VALCSLLRET,0) AS VALCSLLRET,
    COALESCE(RETENCAO.VALISSRET,0) AS VALISSRET,
    DOCFISCAL.VLIBPT+DOCFISCAL.VLIBPTEST+DOCFISCAL.VLIBPTMUN AS TOTALAPROXTRIB,
    DOCFISCAL.VLIBPTEST ,
    DOCFISCAL.PCALIQIBPTEST, 
    DOCFISCAL.VLIBPTMUN,
    DOCFISCAL.PCALIQIBPTMUN, 
    DOCFISCAL.VLIBPT AS VLIBPTFED,
    DOCFISCAL.PCALIQIBPT AS PCIBPTFED,
    DOCFISCAL.DSOBSIBPT,
    cbsibs.idclassificacaotributaria,
    cbsibs.valbasecbsibs,
    cbsibs.cbs_aliquota,
    cbsibs.cbs_percreducao,
    cbsibs.cbs_aliquotareal_efetiva,
    cbsibs.cbs_valor,
    cbsibs.ibsuf_aliquota,
    cbsibs.ibsuf_percreducao,
    cbsibs.ibsuf_aliquotareal_efetiva,
    cbsibs.ibsuf_valor,
    cbsibs.ibsmun_aliquota,
    cbsibs.ibsmun_percreducao,
    cbsibs.ibsmun_aliquotareal_efetiva,
    cbsibs.ibsmun_valor,
    cbsibs.ibs_valor_total,
    DOCFISCAL.VLTOTAL + cbsibs.CBS_Valor + cbsibs.IBS_Valor_Total AS Total_Com_Tributos    
  FROM DOCFISCAL
  JOIN NFERETORNO ON DOCFISCAL.CDDOCFISCAL = NFERETORNO.CDNOTA AND DOCFISCAL.CDEMPRESA = NFERETORNO.CDEMPRESA
  LEFT JOIN (
  SELECT DOCFISCALITEM.CDEMPRESA,DOCFISCALITEM.CDDOCFISCAL,
        MAX(CASE WHEN DOCFISCALITEM.IDCSTPIS = DOCFISCALITEM.IDCSTCOFINS THEN DOCFISCALITEM.IDCSTPIS END ) AS CSTPISCOFINS,
        SUM(DOCFISCALITEM.VLBASEPIS) AS BASEPIS,
        AVG(DOCFISCALITEM.PCPIS) AS ALIQPIS,
        SUM(DOCFISCALITEM.VLPIS ) AS VALPIS_ITEM,
        AVG(DOCFISCALITEM.PCCOFINS) AS ALIQCOFINS,
        SUM(DOCFISCALITEM.VLCOFINS ) AS VALCOFINS_ITEM
  FROM DOCFISCALITEM
  WHERE DOCFISCALITEM.CDEMPRESA = :CDEMPRESA
  AND DOCFISCALITEM.CDDOCFISCAL = :CDNOTA
          AND DOCFISCALITEM.VLPIS>0 AND DOCFISCALITEM.VLCOFINS>0
        GROUP BY DOCFISCALITEM.CDEMPRESA,DOCFISCALITEM.CDDOCFISCAL
  ) AS PISCOFINS ON DOCFISCAL.CDDOCFISCAL = PISCOFINS.CDDOCFISCAL AND DOCFISCAL.CDEMPRESA = PISCOFINS.CDEMPRESA 
  LEFT JOIN ( SELECT
    RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA,
    COALESCE( SUM(RETENCAO.VLPIS)      FILTER (WHERE RETENCAO.FLTRIBUTO IN (5   )), 0) AS VALPISRET, --06–PIS/PASEP
    COALESCE( SUM(RETENCAO.VLCOFINS)   FILTER (WHERE RETENCAO.FLTRIBUTO IN (6   )), 0) AS VALCOFINSRET, --07–COFINS
    COALESCE( SUM(RETENCAO.VLCSLL    ) FILTER (WHERE RETENCAO.FLTRIBUTO IN (   4)), 0) AS VALCSLLRET, --05–CSLL
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  14)), 0) AS VALINSSRET, --15-INSS
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN ( 0,1)), 0) AS VALIRRET, --01–IRPJ--02–IRRF
    COALESCE( SUM(RETENCAO.VLRETENCAO) FILTER (WHERE RETENCAO.FLTRIBUTO IN (  13)), 0) AS VALISSRET --14-ISSQN
    FROM RETENCAO 
    JOIN IMPOSTOFEDERAL ON IMPOSTOFEDERAL.CDIMPOSTOFEDERAL = RETENCAO.CDIMPOSTOFEDERAL
    WHERE RETENCAO.CDEMPRESA = :CDEMPRESA
    AND RETENCAO.CDDOCFISCAL = :CDNOTA
    GROUP BY RETENCAO.CDDOCFISCAL, RETENCAO.CDEMPRESA
  ) AS RETENCAO ON RETENCAO.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL AND RETENCAO.CDEMPRESA = DOCFISCAL.CDEMPRESA 
  LEFT JOIN (SELECT DOCFISCALITEM.CDEMPRESA, DOCFISCALITEM.CDDOCFISCAL,
    COALESCE(NULLIF(
    MAX(DOCFISCALITEMIVADUAL.IDCLASSIFICACAOTRIBUTARIA) FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0)
    ,''),'200048') 
    AS IDCLASSIFICACAOTRIBUTARIA,
    SUM(IBSESTADUAL.VLBASEIMPOSTO) AS VALBASECBSIBS,
    --
    MAX(CBS.PCIMPOSTOBRUTO) FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS CBS_Aliquota,
    MAX(CBS.PCREDUCAO)      FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS CBS_PercReducao,
    MAX(CBS.PCIMPOSTOBRUTO) FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS CBS_aliquotareal_EFETIVA,
    SUM(CBS.VLIMPOSTO) AS CBS_Valor,
    --
    MAX(IBSESTADUAL.PCIMPOSTOBRUTO) FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS ibsUF_aliquota,
    MAX(IBSESTADUAL.PCREDUCAO)      FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS ibsUF_PercReducao,
    MAX(IBSESTADUAL.PCIMPOSTO)      FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS IBSUF_aliquotareal_EFETIVA,
    SUM(IBSESTADUAL.VLIMPOSTO) AS IBSUF_Valor,
    --
    MAX(IBSMUNICIPAL.PCIMPOSTOBRUTO) FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS IBSMun_Aliquota,
    MAX(IBSMUNICIPAL.PCREDUCAO)      FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS IBSMun_PercReducao,
    MAX(IBSMUNICIPAL.PCIMPOSTO)      FILTER (WHERE ESCOLHIDO.CDDOCFISCALITEM > 0) 
    AS IBSMun_aliquotareal_EFETIVA,
    SUM(IBSMUNICIPAL.VLIMPOSTO) AS ibsmun_valor,
    -----
    SUM(IBSESTADUAL.VLIMPOSTO + IBSMUNICIPAL.VLIMPOSTO) AS IBS_Valor_Total
 FROM DOCFISCALITEM 
 JOIN DOCFISCALITEMIVADUAL ON DOCFISCALITEMIVADUAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM AND DOCFISCALITEMIVADUAL.CDEMPRESA = DOCFISCALITEM.CDEMPRESA
 JOIN DOCFISCALITEMIMPOSTO CBS          ON CBS.CDDOCFISCALITEM = docfiscalitemivadual.CDDOCFISCALITEM AND CBS.CDEMPRESA = docfiscalitemivadual.CDEMPRESA AND CBS.CDTIPOIMPOSTODET = 7
 JOIN DOCFISCALITEMIMPOSTO IBSESTADUAL  ON IBSESTADUAL.CDDOCFISCALITEM = docfiscalitemivadual.CDDOCFISCALITEM AND IBSESTADUAL.CDEMPRESA = docfiscalitemivadual.CDEMPRESA AND IBSESTADUAL.CDTIPOIMPOSTODET = 8
 JOIN DOCFISCALITEMIMPOSTO IBSMUNICIPAL ON IBSMUNICIPAL.CDDOCFISCALITEM = docfiscalitemivadual.CDDOCFISCALITEM AND IBSMUNICIPAL.CDEMPRESA = docfiscalitemivadual.CDEMPRESA AND IBSMUNICIPAL.CDTIPOIMPOSTODET = 9
 LEFT JOIN (SELECT CDDOCFISCALITEM 
     FROM DOCFISCALITEM 
      WHERE CDEMPRESA = :CDEMPRESA
      AND CDDOCFISCAL = :CDNOTA
      ORDER BY VLTOTAL DESC
    LIMIT 1
  ) AS ESCOLHIDO ON ESCOLHIDO.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
WHERE DOCFISCALITEM.CDEMPRESA = :CDEMPRESA
  AND DOCFISCALITEM.CDDOCFISCAL = :CDNOTA
GROUP BY DOCFISCALITEM.CDEMPRESA, DOCFISCALITEM.CDDOCFISCAL
) AS cbsibs ON cbsibs.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL AND cbsibs.CDEMPRESA = DOCFISCAL.CDEMPRESA
  WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
  AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
  AND NFERETORNO.FLTIPONOTA = 1