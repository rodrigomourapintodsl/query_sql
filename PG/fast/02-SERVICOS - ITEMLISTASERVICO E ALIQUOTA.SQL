SELECT
    CASE 
        WHEN LISTASERVICO.IDLISTASERVICO ~ '[0-9]{6}' 
        THEN (regexp_match(LISTASERVICO.IDLISTASERVICO,'[0-9]{6}'))[1]
        WHEN LISTASERVICO.IDLISTASERVICO ~ '[0-9]{4}' 
        THEN LISTASERVICO.IDLISTASERVICO|| '01'
        WHEN LISTASERVICO.IDLISTASERVICO ~ '[0-9]{2}\.[0-9]{2}' 
        THEN REPLACE(LISTASERVICO.IDLISTASERVICO,'.','')|| '01'
       WHEN LISTASERVICO.IDLISTASERVICO ~ '[0-9]\.[0-9]{2}' 
        THEN '0'||REPLACE(LISTASERVICO.IDLISTASERVICO,'.','')|| '01'
        WHEN LISTASERVICO.IDLISTASERVICO ~ '[0-9]{4}' 
        THEN COALESCE(cest.idncm) || '01'
        ELSE '0000'||LISTASERVICO.IDLISTASERVICO
    END AS IDLISTASERVICO, --== cTribMun
    nbs.idnbs, 
    produtoempresa.idreferencia,
    (regexp_match(LISTASERVICO.IDLISTASERVICO,'[0-9]{6}\.([0-9]{1,3})'))[1] AS CodigoTributacaoMunicipio,
    cfps.idcfps,
    DOCFISCALITEM.PCISS AS ALIQISS,
    COALESCE(MAX(DOCFISCALITEMIVADUAL.IDCLASSIFICACAOTRIBUTARIA),'100001') AS IDCLASSIFICACAOTRIBUTARIA --IBSCBS
  FROM DOCFISCAL
  JOIN DOCFISCALITEM ON DOCFISCAL.CDDOCFISCAL=DOCFISCALITEM.CDDOCFISCAL AND DOCFISCAL.CDEMPRESA=DOCFISCALITEM.CDEMPRESA
    JOIN PRODUTO ON PRODUTO.CDPRODUTO=DOCFISCALITEM.CDPRODUTO 
    LEFT JOIN LISTASERVICO ON LISTASERVICO.CDLISTASERVICO=PRODUTO.CDLISTASERVICO AND LISTASERVICO.flativo=1
    LEFT JOIN nbs ON nbs.cdnbs=produto.cdnbs and nbs.flativo=1
    LEFT JOIN produtoempresa ON produtoempresa.cdproduto=PRODUTO.CDPRODUTO AND produtoempresa.CDEMPRESA=PRODUTO.CDEMPRESA AND produtoempresa.flativo=1
    LEFT JOIN cest ON cest.cdcest = produtoempresa.cdcest and cest.flativo=1
    LEFT JOIN cfps ON cfps.cdcfps=DOCFISCALITEM.cdcfps AND cfps.flativo=1
 LEFT JOIN DOCFISCALITEMIVADUAL 
 ON DOCFISCALITEMIVADUAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
 LEFT JOIN DOCFISCALITEMIMPOSTO IBSMUNICIPAL 
 ON IBSMUNICIPAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
 AND IBSMUNICIPAL.CDTIPOIMPOSTODET = 9 
  WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
  AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
GROUP BY DOCFISCALITEM.cdproduto,
produtoempresa.idreferencia,
DOCFISCALITEM.PCISS,
DOCFISCALITEM.dsproduto,
LISTASERVICO.IDLISTASERVICO,
nbs.idnbs,DOCFISCALITEM.idcest,
cest.idcest,cest.idncm,
cfps.idcfps,
DOCFISCALITEM.FLCATEGORIA = 4
ORDER BY DOCFISCALITEM.FLCATEGORIA = 4
,SUM(DOCFISCALITEM.vltotal) DESC
LIMIT 1
