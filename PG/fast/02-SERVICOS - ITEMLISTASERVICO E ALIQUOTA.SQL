SELECT
    CASE WHEN LISTASERVICO.IDLISTASERVICO SIMILAR TO '([0-9]{0,1}[1-9]{1}\.{0,1}[0-9]{2}\.{0,1}[0-9]{2})(\.{1}[0-9]{3}){0,4}'
        THEN TRIM(TO_CHAR(CAST(REPLACE(
          (REGEXP_MATCH(LISTASERVICO.IDLISTASERVICO,'([0-9]{0,1}[1-9]{1}\.{0,1}[0-9]{2}\.{0,1}[0-9]{2})(\.{1}[0-9]{3}){0,4}'
          ))[1],'.','') AS INTEGER),'000009'))
        WHEN LISTASERVICO.IDLISTASERVICO SIMILAR TO '[0-9][1-9][0-9]{2}' 
        THEN LISTASERVICO.IDLISTASERVICO|| '01'
        WHEN LISTASERVICO.IDLISTASERVICO SIMILAR TO '[1-9][0-9]{2}' 
        THEN '0'||LISTASERVICO.IDLISTASERVICO|| '01'
        WHEN LISTASERVICO.IDLISTASERVICO SIMILAR TO '[0-9]{1}[1-9]{1}\.[0-9]{2}' 
        THEN REPLACE(LISTASERVICO.IDLISTASERVICO,'.','')|| '01'
        WHEN LISTASERVICO.IDLISTASERVICO SIMILAR TO '[1-9]\.[0-9]{2}' 
        THEN '0'||REPLACE(LISTASERVICO.IDLISTASERVICO,'.','')|| '01'
        ELSE '0000'||LISTASERVICO.IDLISTASERVICO
    END AS IDLISTASERVICO, --== cTribMun
    nbs.idnbs, 
    produtoempresa.idreferencia,
    (regexp_match(LISTASERVICO.IDLISTASERVICO,'[0-9\.]{3,16}[\.\\\/]([0-9]{3,16})'))[1] AS CodigoTributacaoMunicipio,
    cfps.idcfps,
    DOCFISCALITEM.PCISS AS ALIQISS,
    (SELECT sum(VLISS) FROM DOCFISCALITEM 
      WHERE CDEMPRESA = :CDEMPRESA
      AND CDDOCFISCAL = :CDNOTA
    ) AS VLISS,
      '030101' AS Codigo_Indicador_Operacao, --no estabelecimento fornecedor
      '080101' AS IndOp_IBSCBS --(AnexoVII-IndOp_IBSCBS) Valor fixo
  FROM DOCFISCAL
  JOIN DOCFISCALITEM ON DOCFISCAL.CDDOCFISCAL=DOCFISCALITEM.CDDOCFISCAL AND DOCFISCAL.CDEMPRESA=DOCFISCALITEM.CDEMPRESA
    JOIN PRODUTO ON PRODUTO.CDPRODUTO=DOCFISCALITEM.CDPRODUTO 
    LEFT JOIN LISTASERVICO ON LISTASERVICO.CDLISTASERVICO=PRODUTO.CDLISTASERVICO AND LISTASERVICO.flativo=1
    LEFT JOIN nbs ON nbs.cdnbs=produto.cdnbs and nbs.flativo=1
    LEFT JOIN produtoempresa ON produtoempresa.cdproduto=PRODUTO.CDPRODUTO AND produtoempresa.CDEMPRESA=PRODUTO.CDEMPRESA AND produtoempresa.flativo=1
    LEFT JOIN cest ON cest.cdcest = produtoempresa.cdcest and cest.flativo=1
    LEFT JOIN cfps ON cfps.cdcfps=DOCFISCALITEM.cdcfps AND cfps.flativo=1
 LEFT JOIN configuracao AS REFORMATRIBUTARIA on REFORMATRIBUTARIA.cdtipo = 3 AND REFORMATRIBUTARIA.dsparametro = 'CFGREFORMATRIBUTARIA'
 LEFT JOIN DOCFISCALITEMIVADUAL 
 ON DOCFISCALITEMIVADUAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
 AND REFORMATRIBUTARIA.nrvalorint = 1
 LEFT JOIN DOCFISCALITEMIMPOSTO IBSMUNICIPAL 
 ON IBSMUNICIPAL.CDDOCFISCALITEM = DOCFISCALITEM.CDDOCFISCALITEM 
 AND IBSMUNICIPAL.CDTIPOIMPOSTODET = 9 
  WHERE DOCFISCAL.CDEMPRESA = :CDEMPRESA
  AND DOCFISCAL.CDDOCFISCAL = :CDNOTA
  AND REFORMATRIBUTARIA.nrvalorint = 1
GROUP BY DOCFISCALITEM.cdproduto,
produtoempresa.idreferencia,
DOCFISCALITEM.PCISS,
DOCFISCALITEM.dsproduto,
LISTASERVICO.IDLISTASERVICO,
nbs.idnbs,DOCFISCALITEM.idcest,
cest.idcest,cest.idncm,
cfps.idcfps,
DOCFISCALITEM.FLCATEGORIA = 4
ORDER BY DOCFISCALITEM.FLCATEGORIA = 4
,SUM(DOCFISCALITEM.vltotal) DESC
LIMIT 1
