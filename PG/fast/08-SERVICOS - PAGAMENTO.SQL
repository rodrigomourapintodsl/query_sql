SELECT COALESCE(
    PIX.dspix,
    CASE 
        WHEN cartao.fldebcre = 0 THEN 'Débito:'||cartaobandeira.dscartaobandeira
        WHEN cartao.fldebcre = 1 THEN 'Crédito:'||cartaobandeira.dscartaobandeira
    END,
    CARTAO.dscartao,
    CASE 
        WHEN formapag.cdtipoformapag = 11 THEN TIPOFORMAPAG.dstipoformapag||':'||LANCCAIXACONTAHOTEL.cduh
        WHEN formapag.cdtipoformapag = 6 THEN 'Reserva:'||LANCCAIXACONTAHOTEL.cdlocalizadorreserva  
    END,
    FORMAPAG.DSFORMAPAG,
    'TITULO:'||TITULO.dsdocumento,
    'OUTRAS'
) AS XPAG,
2 AS mdPrestacao_comExt,
0 AS vincPrest_comExt,
CASE moeda.fliso4217 --moeda ISO 4217 --https://www.bcb.gov.br/estabilidadefinanceira/todasmoedas
 WHEN  0 THEN '790' --0-BRL - Real
 WHEN  1 THEN '220' --1-USD - Dólar Americano
 WHEN  2 THEN '978' --2-EUR - Euro
 WHEN  3 THEN '706' --3-ARS - Peso Argentino
 WHEN  4 THEN '450' --4-PYG - Guarani
 WHEN  5 THEN '745' --5-UYU - Peso Uruguaio
 WHEN  6 THEN '540' --6-GBP - Libra Esterlina
 WHEN  7 THEN '165' --7-CAD - Dólar Canadense
 WHEN  8 THEN '715' --8-CLP - Peso Chileno
 WHEN  9 THEN '720' --9-COP - Peso Colombiano
 WHEN 10 THEN '741' --10-MXN - Peso Mexicano
 WHEN 11 THEN '660' --11-PEN - Nuevo Sol
 ELSE '790'
END AS tpMoeda_comExt,
DOCFISCAL.VLTOTAL / DETLANCCAIXA.VLCOTACAO AS vServMoeda
FROM EMPRESA
    JOIN DOCFISCAL ON DOCFISCAL.CDEMPRESA = EMPRESA.CDEMPRESA
    JOIN MODELONF ON MODELONF.CDMODELONF = DOCFISCAL.CDMODELOFISCAL
    JOIN NFERETORNO ON NFERETORNO.CDNOTA = DOCFISCAL.CDDOCFISCAL
     AND NFERETORNO.CDEMPRESA = DOCFISCAL.CDEMPRESA 
    LEFT JOIN LANCCAIXA 
          ON NFERETORNO.FLTIPONOTA = 1 AND LANCCAIXA.FLCANCELADO = 0 AND MODELONF.IDCODIGO = '55' AND LANCCAIXA.CDDOCFISCALNFSER= DOCFISCAL.CDDOCFISCAL
    LEFT JOIN LANCCAIXACONTAHOTEL ON LANCCAIXA.CDLANCCAIXA = LANCCAIXACONTAHOTEL.CDLANCCAIXA AND DOCFISCAL.CDEMPRESA = LANCCAIXACONTAHOTEL.CDEMPRESA
    LEFT JOIN docfiscalformapag ON docfiscalformapag.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL                                          
         AND docfiscalformapag.cdempresa = DOCFISCAL.cdempresa 
    LEFT JOIN DETLANCCAIXA 
           ON DETLANCCAIXA.CDDETLANCCAIXA = docfiscalformapag.CDDETLANCCAIXA
          AND DETLANCCAIXA.FLCANCELADODET = 0 AND DETLANCCAIXA.FLSINAL=1
           OR DETLANCCAIXA.CDLANCCAIXA = LANCCAIXA.CDLANCCAIXA AND LANCCAIXA.FLCANCELADO=0
          AND DETLANCCAIXA.FLCANCELADODET = 0 AND DETLANCCAIXA.FLSINAL=1
          AND DETLANCCAIXA.CDDETLANCCAIXA = docfiscalformapag.CDDETLANCCAIXA
    LEFT JOIN FORMAPAG ON FORMAPAG.CDFORMAPAG = COALESCE(DETLANCCAIXA.CDFORMAPAG,docfiscalformapag.CDFORMAPAG)
    LEFT JOIN TIPOFORMAPAG ON TIPOFORMAPAG.CDTIPOFORMAPAG = FORMAPAG.CDTIPOFORMAPAG
    LEFT JOIN DOCFISCALTITULO ON DOCFISCALTITULO.CDDOCFISCAL = DOCFISCAL.CDDOCFISCAL
         AND DETLANCCAIXA.CDFORMAPAG IS NULL
    LEFT JOIN TITULO ON TITULO.CDTITULO = DOCFISCALTITULO.CDTITULO AND TITULO.FLCANCELADO = 0 
          AND TITULO.flrecpag=1 AND TITULO.florigem=16 --16-Saída doc
    LEFT JOIN tipodoccobranca ON tipodoccobranca.cdtipodoccobranca = TITULO.cdtipodoccobranca
          AND tipodoccobranca.flativo = 1 AND tipodoccobranca.florigem IN (0,1,2,3) --0-Duplicata,1-Cheque,2-Cartão,3-Outros
    LEFT JOIN PARCELATITULO ON PARCELATITULO.CDTITULO = TITULO.CDTITULO  AND PARCELATITULO.FLCANCELADO = 0
    LEFT JOIN CARTAOREC ON DETLANCCAIXA.CDDETLANCCAIXA = CARTAOREC.CDDETLANCCAIXA 
          AND CARTAOREC.FLCANCELACARTAO = 0
    LEFT JOIN CARTAO ON CARTAO.CDCARTAO = CARTAOREC.CDCARTAO
          AND FORMAPAG.CDTIPOFORMAPAG = 3
           OR CARTAO.CDCARTAO = TITULO.CDCARTAO
          AND tipodoccobranca.florigem IN (0,1,2,3) --0-Duplicata,1-Cheque,2-Cartão,3-Outros
    LEFT JOIN cartaobandeira ON cartaobandeira.cdcartaobandeira = cartao.cdcartaobandeira AND cartaobandeira.flativo=1
    LEFT JOIN pixtransacao ON pixtransacao.CDDETLANCCAIXA = DETLANCCAIXA.CDDETLANCCAIXA --PIXREC
          AND pixtransacao.CDpixtransacao = CARTAOREC.CDpixtransacao
    LEFT JOIN PIX ON PIX.CDPIX = pixtransacao.CDPIX
    LEFT JOIN configuracao AS MOEDAPADRAO on dsparametro = 'CDMOEDAPADRAO' AND MOEDAPADRAO.cdempresa=docfiscal.cdempresa
    LEFT JOIN moeda ON moeda.cdmoeda = detlanccaixa.cdmoeda AND moeda.cdmoeda <> MOEDAPADRAO.nrvalorint 
    WHERE DOCFISCAL.CDDOCFISCAL = :CDNOTA
    AND EMPRESA.CDEMPRESA = :CDEMPRESA  
    AND DOCFISCAL.FLTIPOEMISSAO = 0 --Propria
    ORDER BY DOCFISCAL.CDDOCFISCAL DESC,DETLANCCAIXA.CDDETLANCCAIXA