SELECT
string_agg(DESCRICAO_SERVICO, ' | ' ORDER BY FLCATEGORIA=4,CDDOCFISCALITEM) AS DESCRICAO_SERVICO
FROM (
                    SELECT MIN(DOCFISCALITEM.CDDOCFISCALITEM) AS CDDOCFISCALITEM,
                         DOCFISCALITEM.FLCATEGORIA,
                         DOCFISCAL.CDDOCFISCAL,
                         DOCFISCALITEM.CDEMPRESA,
                         DOCFISCALITEM.DSPRODUTO 
                        ||CASE 
                        WHEN SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM) > 1 AND SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM) = CAST(SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM) AS INTEGER)
                        THEN ''
                         || ' - '||TRIM(to_char(DOCFISCALITEM.VLUNITARIO + (DOCFISCALITEM.VLTAXASERVICO / SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM)),'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM),'999G999G999G990'))
                        WHEN SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM) > 1
                        THEN ''
                         || ' - '||TRIM(to_char(DOCFISCALITEM.VLUNITARIO + (DOCFISCALITEM.VLTAXASERVICO / SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM)),'999G999G999G990D00'))
                         || ' x '||TRIM(to_char(SUM(DOCFISCALITEM.QTPRODUTO * DOCFISCALITEM.QTEMBALAGEM),'999G999G999G990D00'))
                         ELSE '' END
                         || ' = ' ||TRIM(to_char(SUM(DOCFISCALITEM.VLTOTAL),'999G999G999G990D00'))
                         AS DESCRICAO_SERVICO       
            FROM DOCFISCALITEM
            JOIN PRODUTO ON PRODUTO.CDPRODUTO = DOCFISCALITEM.CDPRODUTO
            JOIN DOCFISCAL ON  DOCFISCAL.CDDOCFISCAL = DOCFISCALITEM.CDDOCFISCAL AND DOCFISCAL.CDEMPRESA = DOCFISCALITEM.CDEMPRESA
            WHERE DOCFISCALITEM.VLTOTAL >=0
            AND DOCFISCALITEM.CDDOCFISCAL = :CDNOTA 
            AND DOCFISCALITEM.CDEMPRESA = :CDEMPRESA
            GROUP BY DOCFISCAL.CDDOCFISCAL, DOCFISCALITEM.CDEMPRESA,
               DOCFISCALITEM.DSPRODUTO,
               DOCFISCALITEM.FLCATEGORIA,
               DOCFISCALITEM.VLUNITARIO,
               DOCFISCALITEM.VLTAXASERVICO
            ORDER BY DOCFISCALITEM.FLCATEGORIA=4,MIN(DOCFISCALITEM.CDDOCFISCALITEM),DOCFISCALITEM.DSPRODUTO
) ITENS_NFE
